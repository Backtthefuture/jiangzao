# V1.4.0 AI智能砍价系统 - 实施完成报告

**状态**: ✅ 代码实现完成 | ⚠️ 需要手动配置

**实施日期**: 2025-11-04

---

## 📋 实施概览

V1.4.0 AI智能砍价系统已完成代码实现，采用"盲盒式神秘砍价"方案，用户输入砍价理由后，AI评估真诚度并给出0-99%的个性化折扣（最低¥0.01）。

### 核心特性
- 🎲 **趣味性强**: 老虎机动画+盲盒开奖体验
- 🤖 **AI驱动**: 火山方舟大模型评估用户真诚度
- 🎫 **优惠券系统**: 24小时有效期，一次性使用
- 🔒 **安全可靠**: 数据库唯一约束+RLS策略
- 📊 **6档折扣**: 彩蛋级(90-99%) → 无折扣(0-3%)

---

## ✅ 已完成的实施内容

### 1. 数据库层 (Database)

#### 新建表: `bargain_attempts`
```sql
-- 砍价记录表（每用户仅限一次）
- id (UUID, 主键)
- user_id (UUID, UNIQUE约束)
- reason (TEXT, 砍价理由)
- ai_score (INTEGER, 0-100)
- discount_percent (DECIMAL, 0-99)
- final_price (DECIMAL, 0.01-9.90)
- coupon_code (TEXT, UNIQUE)
- coupon_expires_at (TIMESTAMPTZ)
- coupon_used (BOOLEAN)
- client_ip + user_agent (审计)
```

#### 修改表: `orders`
```sql
-- 新增优惠券相关字段
- coupon_code (TEXT, UNIQUE索引)
- discount_amount (DECIMAL)
- original_amount (DECIMAL)
```

#### RLS策略
- ✅ 用户只能查看/插入/更新自己的砍价记录
- ✅ Service Role拥有完全访问权限

#### 索引优化
- ✅ user_id, coupon_code, coupon_expires_at, created_at

**迁移文件**: `supabase_migration_v1.4.0_bargain.sql`

---

### 2. 后端API层

#### GET `/api/bargain/status` - 查询砍价状态
- 检查用户是否已砍价
- 返回已有砍价记录（如果存在）
- 401: 未登录
- 200: 返回 `{ canBargain, existingAttempt? }`

#### POST `/api/bargain/submit` - 提交砍价
**验证逻辑**:
- ✅ 用户认证（401）
- ✅ 理由长度（30-300字）
- ✅ 重复检查（每用户仅一次）
- ✅ 频率限制（60秒/用户+IP）

**AI评估流程**:
1. 调用火山方舟API（10秒超时）
2. 自动重试2次（指数退避）
3. 解析JSON响应（支持markdown代码块）
4. 验证响应范围（分数、折扣、价格）
5. **兜底策略**: AI失败时返回20%折扣

**数据保存**:
- 生成唯一优惠券码（格式: `BARGAIN_{timestamp}_{random6}`）
- 设置24小时过期时间
- 保存到 `bargain_attempts` 表

#### 修改 `/api/payment/create-order` - 支持优惠券
- 接收可选的 `couponCode` 参数
- 验证优惠券（存在性、所有权、有效期、使用状态、产品类型）
- 计算折扣后价格
- 订单记录包含优惠券信息

#### 修改 `/api/payment/callback` - 标记优惠券已使用
- 支付成功后自动标记 `coupon_used = true`
- 记录 `coupon_used_at` 时间戳
- 防止重复使用

---

### 3. 业务逻辑层

#### `/lib/ark.ts` - 火山方舟API客户端
**核心函数**:
- `callArkChat()`: 基础API调用（10秒超时）
- `callArkChatWithRetry()`: 带重试的调用（2次重试）
- `evaluateBargainWithArk()`: 砍价评估主函数
- `generateFallbackDiscount()`: 兜底策略（20%折扣）

**配置**:
```env
ARK_API_KEY=a362272a-34cb-4c26-b8d6-7b3ba96f9285
ARK_API_BASE=https://ark.cn-beijing.volces.com/api/v3
ARK_MODEL_ID=ep-20251014152952-p8nsw
```

#### `/lib/bargain.ts` - 砍价业务逻辑
**核心函数**:
- `canUserBargain()`: 检查用户砍价资格
- `generateCouponCode()`: 生成唯一优惠券码
- `validateCoupon()`: 验证优惠券有效性
- `markCouponAsUsed()`: 标记优惠券已使用
- `validateReasonLength()`: 验证输入长度

**配置**:
```env
BARGAIN_ENABLED=true
BARGAIN_COUPON_EXPIRES_HOURS=24
BARGAIN_MIN_REASON_LENGTH=30
BARGAIN_MAX_REASON_LENGTH=300
```

#### `/lib/prompts/bargain.ts` - AI提示词模板
**评分维度**（总分100）:
1. **真诚度** (40分): 情感表达真实自然
2. **具体性** (25分): 提供具体细节
3. **独特性** (20分): 故事独特性
4. **困境度** (15分): 经济困难程度

**6档折扣映射**:
| 总分范围 | 折扣范围 | 最终价格 | 档位 |
|---------|---------|---------|-----|
| 95-100分 | 90-99% | ¥0.01-0.99 | 彩蛋级 🎁 |
| 85-94分  | 40-60% | ¥3.96-5.94 | 大折扣 💰 |
| 70-84分  | 20-35% | ¥6.44-7.92 | 中折扣 🎫 |
| 50-69分  | 10-15% | ¥8.42-8.91 | 小折扣 🏷️ |
| 30-49分  | 5-8%   | ¥9.11-9.41 | 安慰奖 🎈 |
| 0-29分   | 0-3%   | ¥9.60-9.90 | 无折扣 😢 |

---

### 4. 前端UI层

#### `/app/pricing/page.tsx` - 定价页（已修改）
**新增内容**:
- "🎲 摇一摇神秘优惠" 按钮（仅月会员）
- 黄色渐变背景+虚线边框
- "最低¥0.01" 徽章
- "每人仅可摇一次，折扣最高可达99%" 提示
- 弹窗状态管理

#### `/components/bargain/BargainModal.tsx` - 砍价弹窗主组件
**多步骤流程**:

1. **输入步骤** (input):
   - Textarea输入框（30-300字）
   - 实时字符计数器（颜色变化）
   - 提交按钮（<30字禁用）
   - 提示：真诚的故事更容易获得高折扣

2. **加载步骤** (loading):
   - 老虎机动画（SlotMachineAnimation）
   - 进度条（0% → 100%，2.5秒）
   - 步骤提示（评估真诚度 → 计算折扣 → 生成优惠券）

3. **结果步骤** (result):
   - 折扣百分比（旋转黄金样式）
   - AI点评消息（60-120字，温暖语气）
   - 价格对比表（原价 → 优惠 → 实付）
   - 优惠券码+过期时间
   - "立即支付" 按钮（调用create-order）

4. **已有记录步骤** (existing):
   - 显示之前的砍价结果
   - 提示："你已经砍价过了，每个用户只能砍价一次哦"

5. **错误步骤** (error):
   - 错误图标+错误消息
   - 重试/关闭按钮

#### `/components/bargain/SlotMachineAnimation.tsx` - 老虎机动画
**视觉效果**:
- 3个老虎机符号（每100ms切换）
- 8种符号: 🎰 💰 🎁 🎉 ✨ 💫 🌟 ⭐
- 进度条动画（每50ms增加2%）
- 步骤消息轮播（3个阶段）
- 加载点动画（3个圆点，延迟脉动）

---

### 5. 类型定义

#### `/lib/types.ts` - 新增类型（V1.4.0）
```typescript
// 砍价记录
export interface BargainAttempt {
  id: string;
  user_id: string;
  user_email?: string;
  reason: string;
  reason_length: number;
  ai_score: number;
  discount_percent: number;
  final_price: number;
  ai_message: string;
  coupon_code: string;
  coupon_expires_at: string;
  coupon_used: boolean;
  coupon_used_at?: string;
  // ... 更多字段
}

// 砍价状态响应
export interface BargainStatusResponse {
  success: boolean;
  canBargain: boolean;
  existingAttempt?: BargainAttempt;
  error?: string;
}

// 砍价提交响应
export interface BargainSubmitResponse {
  success: boolean;
  result?: {
    score: number;
    discount_percent: number;
    final_price: number;
    message: string;
    coupon_code: string;
    expires_at: string;
  };
  error?: string;
}

// 优惠券验证结果
export interface CouponValidationResult {
  valid: boolean;
  reason?: string;
  attempt?: BargainAttempt;
}
```

---

### 6. 路由保护修改

#### `/lib/supabase/middleware.ts` - 使定价页公开
```typescript
// V1.4.0: /pricing 路由现在无需登录即可访问
request.nextUrl.pathname !== '/pricing'
```

**原因**: 典型电商流程中，定价页应该是公开的，用户可以先浏览价格，点击砍价按钮后再引导登录。

---

## ⚠️ 需要手动完成的配置

### 🚨 CRITICAL #1: 添加 Supabase Service Role Key

**当前状态**: `.env.local` 中已添加注释提示，但**密钥本身需要你手动获取**

**步骤**:
1. 打开 Supabase Dashboard: https://supabase.com/dashboard
2. 选择你的项目 (`tnzmfewajmptyxwcunpu`)
3. 导航到 **Settings** → **API**
4. 找到 **Project API keys** 部分
5. 复制 **service_role** key（显示为 `secret`，需要点击显示）
6. 打开 `.env.local` 文件
7. 找到第21行的注释，取消注释并粘贴密钥:
   ```env
   SUPABASE_SERVICE_ROLE_KEY=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9... (你的密钥)
   ```
8. 保存文件
9. **重启dev服务器**: `npm run dev`

**为什么需要**: `/api/bargain/submit` 使用 Service Role 客户端来绕过 RLS 策略，直接插入数据到 `bargain_attempts` 表。没有这个密钥，API会崩溃。

---

### 🚨 CRITICAL #2: 执行数据库迁移

**当前状态**: 迁移文件已创建 (`supabase_migration_v1.4.0_bargain.sql`)，但**未执行**

**步骤**:
1. 打开 Supabase Dashboard: https://supabase.com/dashboard
2. 选择你的项目 (`tnzmfewajmptyxwcunpu`)
3. 导航到 **SQL Editor**
4. 点击 **New query**
5. 打开本地文件 `supabase_migration_v1.4.0_bargain.sql`
6. 复制所有内容（约150行SQL）
7. 粘贴到SQL编辑器
8. 点击 **Run** 执行
9. 确认成功提示（应该显示 "Success. No rows returned"）
10. 验证表已创建:
    ```sql
    SELECT * FROM bargain_attempts LIMIT 1;
    SELECT * FROM orders LIMIT 1;
    ```

**为什么需要**: 没有 `bargain_attempts` 表，所有砍价API调用都会返回 "table does not exist" 错误。

---

## 🧪 测试清单

### 前置条件
- ✅ 已添加 `SUPABASE_SERVICE_ROLE_KEY`
- ✅ 已执行数据库迁移
- ✅ Dev服务器已重启 (`npm run dev`)
- ✅ 已登录测试账号（或准备注册新账号）

### 1. 定价页UI测试
访问: http://localhost:3001/pricing

- [ ] 页面无需登录即可访问
- [ ] 显示3个会员套餐（月/年/终身）
- [ ] "🎲 摇一摇神秘优惠" 按钮**仅**出现在月会员卡片
- [ ] 按钮样式：黄色渐变背景+虚线边框
- [ ] 显示 "最低¥0.01" 徽章
- [ ] 显示 "每人仅可摇一次，折扣最高可达99%" 提示

### 2. 砍价弹窗测试 - 输入步骤
- [ ] 点击砍价按钮，弹窗打开
- [ ] 弹窗标题: "🎲 摇一摇神秘优惠"
- [ ] Textarea可输入文本
- [ ] 字符计数器实时更新
- [ ] 输入<30字时，计数器显示红色
- [ ] 输入≥30字时，显示绿色✓
- [ ] 提交按钮在<30字时禁用，显示 "还需要 X 字"
- [ ] 输入≥30字时，按钮可点击，显示 "提交"
- [ ] 尝试输入29字 → 按钮保持禁用
- [ ] 输入30字以上 → 按钮变为可点击

### 3. 砍价弹窗测试 - 加载步骤
- [ ] 点击提交，弹窗切换到加载状态
- [ ] 显示3个老虎机符号（动画旋转）
- [ ] 符号每100ms切换一次
- [ ] 显示进度条（从0%增长到100%）
- [ ] 显示步骤提示（"正在评估你的真诚度..." → "计算专属折扣..." → "生成优惠券..."）
- [ ] 加载动画持续约2.5秒

### 4. 砍价弹窗测试 - 结果步骤
- [ ] 加载完成后显示结果
- [ ] 折扣百分比突出显示（如 "50% OFF!"）
- [ ] 显示AI点评消息（应该与你的输入相关）
- [ ] 价格对比表显示:
  - 原价: ¥9.9
  - 优惠: -¥X.XX (XX%)
  - 实付: ¥X.XX
- [ ] 显示优惠券码（格式: `BARGAIN_xxxxxxxxxx_XXXXXX`）
- [ ] 显示过期时间（约24小时后）
- [ ] 显示 "💰 ¥X.XX 立即支付" 按钮
- [ ] 显示 "稍后" 按钮

### 5. 第二次尝试测试
- [ ] 关闭弹窗
- [ ] 再次点击砍价按钮
- [ ] 弹窗应直接显示之前的结果（不允许重新输入）
- [ ] 显示提示: "你已经砍价过了，每个用户只能砍价一次哦"

### 6. API端点测试（使用curl或Postman）

#### 测试未登录状态
```bash
curl http://localhost:3001/api/bargain/status
# 预期: {"success":false,"canBargain":false,"error":"请先登录"} (401)
```

#### 测试已登录状态（需要替换cookie）
```bash
# 1. 获取session cookie（登录后从浏览器开发者工具复制）
# 2. 查询砍价状态
curl http://localhost:3001/api/bargain/status \
  -H "Cookie: sb-tnzmfewajmptyxwcunpu-auth-token=YOUR_TOKEN_HERE"
# 预期: {"success":true,"canBargain":true} 或 existingAttempt

# 3. 提交砍价（有效输入）
curl -X POST http://localhost:3001/api/bargain/submit \
  -H "Content-Type: application/json" \
  -H "Cookie: sb-tnzmfewajmptyxwcunpu-auth-token=YOUR_TOKEN_HERE" \
  -d '{"reason":"我是一名AI从业者，每天都在学习最新的技术动态。作为初创团队的一员，预算有限但求知欲很强。希望能通过这个平台更深入地了解行业前沿，提升自己的专业能力。真诚期待能以优惠价格获得会员资格！"}'
# 预期: {"success":true,"result":{score,discount_percent,final_price,message,coupon_code,expires_at}}

# 4. 测试输入过短
curl -X POST http://localhost:3001/api/bargain/submit \
  -H "Content-Type: application/json" \
  -H "Cookie: sb-tnzmfewajmptyxwcunpu-auth-token=YOUR_TOKEN_HERE" \
  -d '{"reason":"我想要优惠"}'
# 预期: {"success":false,"error":"理由过短，至少需要 30 字"} (400)

# 5. 测试频率限制（60秒内提交2次）
# 第一次提交后立即再次提交
curl -X POST http://localhost:3001/api/bargain/submit \
  -H "Content-Type: application/json" \
  -H "Cookie: sb-tnzmfewajmptyxwcunpu-auth-token=YOUR_TOKEN_HERE" \
  -d '{"reason":"<30字以上的理由>"}'
# 预期: {"success":false,"error":"请求过于频繁，请稍后再试"} (429)
```

### 7. 支付流程测试（端到端）
- [ ] 完成砍价后，点击 "立即支付" 按钮
- [ ] 系统应调用 `/api/payment/create-order` 并传入优惠券码
- [ ] 订单应以折扣后价格创建
- [ ] 跳转到Z-Pay支付页面
- [ ] （测试环境可能无法完成实际支付，但订单应该创建成功）

### 8. 数据库验证
```sql
-- 查看砍价记录
SELECT
  user_id,
  reason_length,
  ai_score,
  discount_percent,
  final_price,
  coupon_code,
  coupon_expires_at,
  coupon_used
FROM bargain_attempts
ORDER BY created_at DESC
LIMIT 10;

-- 查看使用了优惠券的订单
SELECT
  order_id,
  user_email,
  product_type,
  original_amount,
  discount_amount,
  amount as final_amount,
  coupon_code,
  status
FROM orders
WHERE coupon_code IS NOT NULL
ORDER BY created_at DESC;
```

---

## 📊 技术架构总结

### 数据流向

```
用户点击砍价按钮
  ↓
BargainModal.tsx 打开（检查状态）
  ↓
GET /api/bargain/status
  ↓ (首次)
显示输入表单（30-300字）
  ↓
用户输入理由并提交
  ↓
显示加载动画（2.5秒）
  ↓
POST /api/bargain/submit
  ├─ 验证登录状态
  ├─ 验证输入长度
  ├─ 检查重复砍价
  ├─ 频率限制检查
  ├─ 调用火山方舟API评估
  │   ├─ 第1次尝试（10秒超时）
  │   ├─ 第2次重试（1秒延迟）
  │   ├─ 第3次重试（2秒延迟）
  │   └─ 兜底: 20%折扣
  ├─ 生成优惠券码
  ├─ 计算过期时间
  └─ 保存到数据库
  ↓
显示结果（折扣+优惠券）
  ↓
用户点击"立即支付"
  ↓
POST /api/payment/create-order (带couponCode)
  ├─ 验证优惠券有效性
  ├─ 计算折扣后价格
  └─ 创建订单记录
  ↓
跳转到Z-Pay支付页面
  ↓
支付成功后回调
  ↓
POST /api/payment/callback
  ├─ 激活会员
  ├─ 标记优惠券已使用
  └─ 订单状态→completed
```

### 安全措施

1. **数据库层**:
   - ✅ RLS策略（用户只能访问自己的数据）
   - ✅ UNIQUE约束（user_id, coupon_code）
   - ✅ CHECK约束（分数、折扣、价格范围）

2. **API层**:
   - ✅ 用户认证检查（所有端点）
   - ✅ 输入长度验证（30-300字）
   - ✅ 频率限制（60秒/用户+IP）
   - ✅ 重复检查（每用户仅一次）
   - ✅ 优惠券验证（所有权、有效期、使用状态）

3. **业务层**:
   - ✅ AI超时控制（10秒）
   - ✅ 自动重试机制（2次）
   - ✅ 兜底策略（20%折扣）
   - ✅ 优惠券唯一性（时间戳+随机字符）

---

## 🔧 配置文件总览

### `.env.local` (部分)
```env
# Supabase配置
NEXT_PUBLIC_SUPABASE_URL=https://tnzmfewajmptyxwcunpu.supabase.co
NEXT_PUBLIC_SUPABASE_ANON_KEY=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...
# ⚠️ 需要手动添加:
# SUPABASE_SERVICE_ROLE_KEY=你的service_role密钥

# 火山方舟 AI 配置
ARK_API_KEY=a362272a-34cb-4c26-b8d6-7b3ba96f9285
ARK_API_BASE=https://ark.cn-beijing.volces.com/api/v3
ARK_MODEL_ID=ep-20251014152952-p8nsw

# 砍价功能配置
BARGAIN_ENABLED=true
BARGAIN_COUPON_EXPIRES_HOURS=24
BARGAIN_MIN_REASON_LENGTH=30
BARGAIN_MAX_REASON_LENGTH=300
```

---

## 📁 新增/修改文件清单

### 新增文件 (13个)
1. `supabase_migration_v1.4.0_bargain.sql` - 数据库迁移脚本
2. `lib/ark.ts` - 火山方舟API客户端
3. `lib/prompts/bargain.ts` - AI提示词模板
4. `lib/bargain.ts` - 砍价业务逻辑
5. `app/api/bargain/status/route.ts` - 查询砍价状态API
6. `app/api/bargain/submit/route.ts` - 提交砍价API
7. `components/bargain/BargainModal.tsx` - 砍价弹窗主组件
8. `components/bargain/SlotMachineAnimation.tsx` - 老虎机动画组件
9. `V1.4.0_IMPLEMENTATION_SUMMARY.md` - 本文档

### 修改文件 (6个)
1. `.env.local` - 添加火山方舟配置+Service Role Key提示
2. `lib/types.ts` - 添加V1.4.0类型定义（34-211行）
3. `app/pricing/page.tsx` - 添加砍价入口按钮
4. `app/api/payment/create-order/route.ts` - 支持优惠券参数
5. `app/api/payment/callback/route.ts` - 标记优惠券已使用
6. `lib/supabase/middleware.ts` - 使/pricing路由公开
7. `prd.md` - 添加V1.4.0完整需求文档（顶部）

---

## 🎯 下一步行动

### 立即执行（必须）
1. ✅ 从Supabase获取并添加 `SUPABASE_SERVICE_ROLE_KEY`
2. ✅ 执行数据库迁移 `supabase_migration_v1.4.0_bargain.sql`
3. ✅ 重启dev服务器 `npm run dev`
4. ✅ 按照测试清单进行功能验证

### 短期优化（建议）
1. 添加结构化日志（Winston/Pino）
2. 监控AI API失败率
3. 添加Sentry错误追踪
4. 实现Redis分布式频率限制
5. A/B测试不同的AI提示词
6. 添加砍价转化率埋点

### 长期迭代（可选）
1. 单元测试（Jest）
2. 集成测试（Playwright）
3. 社交分享功能（晒折扣）
4. 推荐好友砍价功能
5. 季节性折扣加成
6. 优惠券转赠功能

---

## ❓ 常见问题

### Q1: 砍价按钮点击后没有反应？
**A**: 检查浏览器控制台是否有错误。可能原因:
1. 未执行数据库迁移（表不存在）
2. 未添加 Service Role Key
3. 火山方舟API密钥无效

### Q2: AI评估一直失败，返回20%折扣？
**A**: 这是兜底策略正常工作。可能原因:
1. 火山方舟API额度用完
2. 网络连接问题
3. API密钥失效

解决方法:
- 检查火山方舟控制台的API调用记录
- 查看服务器日志中的错误信息
- 验证 `ARK_API_KEY` 是否正确

### Q3: 为什么每个用户只能砍价一次？
**A**: 这是产品设计决策，原因:
1. 防止滥用（多次尝试获取最高折扣）
2. 提高珍惜度（一次机会，用户会更认真）
3. 降低AI API成本
4. 数据库唯一约束 `UNIQUE(user_id)` 强制执行

### Q4: 可以修改折扣档位吗？
**A**: 可以！编辑 `/lib/prompts/bargain.ts` 中的折扣映射表（74-86行），然后修改AI提示词中的档位说明。

### Q5: 优惠券过期时间可以调整吗？
**A**: 可以！修改 `.env.local` 中的 `BARGAIN_COUPON_EXPIRES_HOURS`（默认24小时）。

---

## 📞 联系支持

如果在实施过程中遇到问题:
1. 检查本文档的"常见问题"部分
2. 查看服务器日志 `npm run dev` 输出
3. 检查浏览器控制台错误
4. 查看Supabase Dashboard中的日志
5. 查看火山方舟控制台的API调用记录

---

**实施完成时间**: 2025-11-04
**版本**: V1.4.0
**文档作者**: Claude Code
