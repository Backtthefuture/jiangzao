# V1.4.3 测试验证清单

**版本**: V1.4.3
**发布日期**: 2025-11-06
**修复内容**: Z-Pay 支付回调后用户被强制登出问题

---

## 📋 测试前准备

### 1. 确认部署完成

- [ ] GitHub 代码已推送成功 (commit: 5808f78)
- [ ] Vercel 自动部署已完成
- [ ] 访问 https://jiangzao2025.vercel.app 能正常加载首页
- [ ] 检查 Vercel Dashboard → Deployments，最新部署状态为 "Ready"

### 2. 准备测试账号

- [ ] 已有测试账号（或注册新账号用于测试）
- [ ] 测试账号邮箱: __________________
- [ ] 测试账号已完成邮箱验证
- [ ] 测试账号当前会员状态: 非会员 / 月会员 / 年会员 / 终身会员

### 3. 准备测试环境

- [ ] 浏览器: Chrome/Firefox/Safari（推荐使用隐私模式避免缓存干扰）
- [ ] 测试金额: ¥0.01 或使用砍价优惠券
- [ ] Z-Pay 商户后台登录准备好（用于查看回调状态）
- [ ] 微信支付账号准备好（当前仅支持微信支付）

---

## ✅ 核心修复验证（必测项）

### 测试 1: 完整支付流程 - 保持登录状态

**目的**: 验证正常情况下支付流程完整，会员权益正确激活

**步骤**:

1. [ ] 登录测试账号
2. [ ] 访问 `/pricing` 定价页
3. [ ] 选择月会员套餐，点击"立即购买"
4. [ ] 确认跳转到 Z-Pay 支付页面
5. [ ] 完成微信支付（使用 ¥0.01 或优惠券）
6. [ ] 支付成功后，Z-Pay 自动跳转回 `/payment/result?order_id=xxx`

**预期结果**:

- [ ] ✅ 跳转到 `/payment/result` 页面时**未被强制登出**
- [ ] ✅ 页面显示"正在查询订单状态..."
- [ ] ✅ 2-5 秒内页面显示"支付成功！"
- [ ] ✅ 订单信息显示正确（订单号、套餐、金额、支付时间）
- [ ] ✅ 右上角用户菜单显示"月会员"标识
- [ ] ✅ 点击"开始阅读"能正常跳转首页
- [ ] ✅ 首页内容全部可阅读，无访问限制弹窗

**数据库验证**:

- [ ] Supabase `orders` 表，订单状态为 `completed`
- [ ] Supabase `orders` 表，`callback_received_at` 字段有值
- [ ] Supabase `orders` 表，`trade_no` 字段有 Z-Pay 交易号
- [ ] Supabase `user_memberships` 表，会员状态为 `active`
- [ ] Supabase `user_memberships` 表，`expires_at` 时间正确（当前时间 + 30天）

**Z-Pay 后台验证**:

- [ ] 商户后台订单状态为"已支付"
- [ ] **不再显示**"已付款，未通知"
- [ ] 回调通知记录显示"通知成功"

---

### 测试 2: Z-Pay 回调接口独立测试

**目的**: 验证 Z-Pay 服务器能直接调用回调接口，不被 Middleware 拦截

**前置准备**:

1. [ ] 在 Supabase `orders` 表中找到一个 `pending` 状态的订单
2. [ ] 记录订单号: __________________
3. [ ] 记录订单金额: __________________

**使用测试脚本**:

```bash
cd /Users/superhuang/Documents/jiangzao-main
chmod +x scripts/test-zpay-callback.sh

# 编辑脚本，修改以下配置:
# - CALLBACK_URL="https://jiangzao2025.vercel.app/api/payment/callback"
# - OUT_TRADE_NO="实际的 pending 订单号"
# - MONEY="订单实际金额"

./scripts/test-zpay-callback.sh
```

**预期结果**:

- [ ] ✅ GET 请求测试通过，响应 `success`
- [ ] ✅ POST 请求测试通过，响应 `success`
- [ ] ✅ HTTP 状态码均为 `200`
- [ ] ❌ **不出现** `405 Method Not Allowed`
- [ ] ❌ **不出现** `401 Unauthorized`
- [ ] ❌ **不出现** `403 Forbidden`

**数据库验证**:

- [ ] Supabase `orders` 表，订单状态从 `pending` 更新为 `completed`
- [ ] Supabase `user_memberships` 表，会员已激活

---

### 测试 3: 跨域跳转丢失会话情况

**目的**: 验证即使用户会话丢失，Z-Pay 回调仍能正常处理

**模拟场景**:

1. [ ] 登录测试账号
2. [ ] 创建支付订单，跳转到 Z-Pay 支付页面
3. [ ] **在 Z-Pay 支付页面等待时**，打开新标签页
4. [ ] 在新标签页手动退出登录（或删除浏览器 Cookie）
5. [ ] 返回 Z-Pay 支付页面，完成支付
6. [ ] Z-Pay 跳转回 `/payment/result?order_id=xxx`

**预期结果**:

- [ ] ✅ `/payment/result` 页面能正常访问（不被强制跳转到登录页）
- [ ] ⚠️ 页面可能显示"请先登录"（因为 `/api/payment/check-status/` 需要认证）
- [ ] ✅ **关键**: Supabase 订单状态仍更新为 `completed`
- [ ] ✅ **关键**: Z-Pay 后台显示"通知成功"
- [ ] ✅ 用户重新登录后，会员权益已激活

**为什么这样设计**:

- `/payment/result` 页面公开访问，避免 Middleware 拦截
- Z-Pay 回调 (`/api/payment/callback`) 独立处理订单，不依赖用户会话
- 即使页面无法实时显示订单状态，后台回调已完成会员激活

---

## 🔒 安全回归测试（必测项）

### 测试 4: 受保护路由仍需认证

**目的**: 确保修复不影响其他需要认证的路由

**步骤**:

1. [ ] 退出登录（确保未登录状态）
2. [ ] 尝试访问以下受保护路由:

| 路由 | 预期行为 | 测试结果 |
|-----|---------|---------|
| `/user/membership` | 重定向到 `/auth/login` | [ ] 通过 |
| `/user/reading-history` | 重定向到 `/auth/login` | [ ] 通过 |
| `/api/payment/create-order` (POST) | 返回 401 Unauthorized | [ ] 通过 |
| `/api/payment/check-status/xxx` (GET) | 返回 401 Unauthorized | [ ] 通过 |

**预期结果**:

- [ ] ✅ 所有受保护路由仍需要认证
- [ ] ❌ 不应允许未登录用户访问

---

### 测试 5: 公开路由仍正常访问

**目的**: 确保修复不影响已有的公开路由

**步骤**:

1. [ ] 退出登录（确保未登录状态）
2. [ ] 尝试访问以下公开路由:

| 路由 | 预期行为 | 测试结果 |
|-----|---------|---------|
| `/` | 正常加载首页 | [ ] 通过 |
| `/pricing` | 正常加载定价页 | [ ] 通过 |
| `/content/xxx` | 正常加载内容详情页（受访问限制影响） | [ ] 通过 |
| `/tags/xxx` | 正常加载标签页 | [ ] 通过 |
| `/guests/xxx` | 正常加载嘉宾页 | [ ] 通过 |
| `/auth/login` | 正常加载登录页 | [ ] 通过 |
| `/auth/signup` | 正常加载注册页 | [ ] 通过 |

**预期结果**:

- [ ] ✅ 所有公开路由正常访问
- [ ] ❌ 不应出现意外的认证跳转

---

### 测试 6: Z-Pay 回调签名验证

**目的**: 确保回调接口安全，防止伪造回调

**使用测试脚本（错误签名）**:

```bash
cd /Users/superhuang/Documents/jiangzao-main

# 编辑 test-zpay-callback.sh，故意修改 ZPAY_KEY 为错误值
# 例如: ZPAY_KEY="wrong_key_for_testing"

./scripts/test-zpay-callback.sh
```

**预期结果**:

- [ ] ✅ HTTP 状态码为 `403 Forbidden`
- [ ] ✅ 响应内容为 `fail`
- [ ] ✅ 订单状态**未更新**
- [ ] ✅ 会员权益**未激活**

---

## 🧪 边界场景测试（可选项）

### 测试 7: 重复回调幂等性

**目的**: 验证 Z-Pay 多次回调不会导致数据异常

**步骤**:

1. [ ] 完成一次成功支付（订单状态为 `completed`）
2. [ ] 使用测试脚本，用相同订单号再次发送回调
3. [ ] 重复 2-3 次

**预期结果**:

- [ ] ✅ 所有回调均返回 `success`（避免 Z-Pay 重复通知）
- [ ] ✅ 订单状态保持 `completed`，不会重复处理
- [ ] ✅ 会员有效期**不会叠加**
- [ ] ✅ 优惠券状态保持 `used`，不会重置

---

### 测试 8: 并发回调

**目的**: 验证在高并发情况下回调处理的稳定性

**步骤**:

1. [ ] 创建测试订单，保持 `pending` 状态
2. [ ] 使用测试脚本，同时发送 5 个相同的回调请求

**预期结果**:

- [ ] ✅ 所有回调均返回 `success`
- [ ] ✅ 订单状态为 `completed`
- [ ] ✅ 会员仅激活一次，不会产生多条记录
- [ ] ✅ 不出现数据库竞态条件错误

---

### 测试 9: 砍价优惠券支付

**目的**: 验证使用砍价优惠券支付流程正常

**步骤**:

1. [ ] 访问 `/pricing`，点击月会员"摇一摇神秘优惠"
2. [ ] 输入理由，获得砍价优惠券
3. [ ] 记录优惠券码: __________________
4. [ ] 使用优惠券完成支付
5. [ ] 验证支付成功后优惠券状态

**预期结果**:

- [ ] ✅ 支付金额为折扣后的价格
- [ ] ✅ 订单表 `coupon_code` 字段记录优惠券码
- [ ] ✅ 订单表 `original_amount` 记录原价
- [ ] ✅ 订单表 `discount_amount` 记录折扣金额
- [ ] ✅ Supabase `bargain_attempts` 表，优惠券状态为 `used`
- [ ] ✅ 优惠券不可重复使用

---

## 📊 Vercel 日志检查（推荐）

### 查看部署日志

1. [ ] 访问 Vercel Dashboard → 项目 → Deployments
2. [ ] 点击最新部署 → "View Function Logs"
3. [ ] 搜索关键字: `[CALLBACK]`

**期望看到的日志**:

```
[CALLBACK] 收到回调 { timestamp, out_trade_no, money, trade_status }
[CALLBACK] 签名验证通过
[CALLBACK] 订单状态更新为 paid
[CALLBACK] 激活会员成功
[CALLBACK] 优惠券已标记为已使用 (如果使用了优惠券)
[CALLBACK] 处理成功
```

**不应出现的错误**:

- [ ] ❌ `405 Method Not Allowed`
- [ ] ❌ `401 Unauthorized`
- [ ] ❌ `403 Forbidden` (排除签名错误测试)
- [ ] ❌ `500 Internal Server Error`

---

## 🎯 成功标准

**核心指标（必须全部满足）**:

- [ ] ✅ 用户支付完成后**不再被强制登出**
- [ ] ✅ Z-Pay 后台订单状态为"已支付"，**不显示**"已付款，未通知"
- [ ] ✅ Supabase 订单状态从 `pending` → `paid` → `completed`
- [ ] ✅ 会员权益正确激活，有效期正确
- [ ] ✅ 受保护路由仍需认证（安全不受影响）
- [ ] ✅ Z-Pay 回调接口签名验证正常工作

**性能指标**:

- [ ] ✅ 支付回调响应时间 < 2秒
- [ ] ✅ 用户在结果页看到"支付成功"时间 < 10秒

---

## ❌ 失败场景及排查

### 如果测试 1 失败（用户仍被登出）

**排查步骤**:

1. [ ] 检查 Vercel 是否部署了最新代码 (commit 5808f78)
2. [ ] 检查 `lib/supabase/middleware.ts` 是否包含两行新增代码
3. [ ] 清除浏览器缓存和 Cookie，重新测试
4. [ ] 查看 Vercel Function Logs，搜索 `middleware`

### 如果测试 2 失败（回调返回 401/403）

**排查步骤**:

1. [ ] 检查测试脚本中 `ZPAY_KEY` 是否与 Vercel 环境变量一致
2. [ ] 检查测试脚本中 `ZPAY_PID` 是否与 Vercel 环境变量一致
3. [ ] 检查 `OUT_TRADE_NO` 是否存在于 Supabase `orders` 表
4. [ ] 检查 `MONEY` 金额是否与订单金额完全一致（精确到小数点后两位）
5. [ ] 查看 Vercel Function Logs，搜索 `[CALLBACK]` 获取详细错误信息

### 如果测试 4 失败（受保护路由变成公开）

**严重问题！立即回滚！**

1. [ ] 执行 `git revert HEAD`
2. [ ] 推送回滚 `git push`
3. [ ] 等待 Vercel 重新部署
4. [ ] 重新分析代码逻辑错误

---

## 📝 测试报告模板

**测试人**: __________________
**测试时间**: __________________
**测试环境**: Vercel Production
**代码版本**: V1.4.3 (commit: 5808f78)

### 核心修复测试结果

| 测试项 | 状态 | 备注 |
|-------|------|------|
| 测试 1: 完整支付流程 | [ ] 通过 [ ] 失败 | |
| 测试 2: 回调接口独立测试 | [ ] 通过 [ ] 失败 | |
| 测试 3: 跨域会话丢失 | [ ] 通过 [ ] 失败 | |

### 安全回归测试结果

| 测试项 | 状态 | 备注 |
|-------|------|------|
| 测试 4: 受保护路由认证 | [ ] 通过 [ ] 失败 | |
| 测试 5: 公开路由访问 | [ ] 通过 [ ] 失败 | |
| 测试 6: 签名验证 | [ ] 通过 [ ] 失败 | |

### 边界场景测试结果

| 测试项 | 状态 | 备注 |
|-------|------|------|
| 测试 7: 重复回调幂等性 | [ ] 通过 [ ] 失败 [ ] 未测 | |
| 测试 8: 并发回调 | [ ] 通过 [ ] 失败 [ ] 未测 | |
| 测试 9: 砍价优惠券 | [ ] 通过 [ ] 失败 [ ] 未测 | |

### 总体结论

- [ ] ✅ **全部通过** - V1.4.3 可以上线
- [ ] ⚠️ **部分通过** - 需要修复以下问题: __________________
- [ ] ❌ **测试失败** - 需要回滚并重新修复

### 发现的问题

1. __________________
2. __________________
3. __________________

---

## 🚀 测试完成后的操作

### 如果测试通过

1. [ ] 将此测试清单标记为"已通过"并存档
2. [ ] 更新 `prd.md` 中 V1.4.3 的状态为"已发布"
3. [ ] 在 GitHub 创建 Release Tag `v1.4.3`
4. [ ] 通知相关人员功能已修复
5. [ ] 监控生产环境日志 24 小时，确保无异常

### 如果测试失败

1. [ ] 记录失败详情和错误日志
2. [ ] 执行 `git revert` 回滚代码
3. [ ] 分析失败原因
4. [ ] 修复后重新发版
5. [ ] 重新执行完整测试

---

**最后更新**: 2025-11-06
**文档版本**: V1.4.3
**维护人**: Claude Code
