# 飞书权限问题完整排查清单

## 错误信息
```
code: 99991672
msg: 'Access denied. One of the following scopes is required: [bitable:app:readonly, bitable:app, base:record:retrieve]'
```

## 完整排查步骤

### 第一步：确认应用权限配置

1. **访问权限管理页面**
   - URL: https://open.feishu.cn/app/cli_a989e0fcbd7f100c/secureset/permission

2. **检查权限状态**
   - [ ] 是否勾选了 `bitable:app:readonly` 权限？
   - [ ] 权限状态是"已开通"还是"待审核"？
   - [ ] 是否还有其他相关权限（如 `bitable:app` 或 `base:record:retrieve`）？

3. **截图位置**
   请截图发给我：权限列表页面，特别是包含 bitable 相关的权限部分

---

### 第二步：确认应用版本发布状态

1. **访问版本管理页面**
   - URL: https://open.feishu.cn/app/cli_a989e0fcbd7f100c/version

2. **检查最新版本**
   - [ ] 最新版本的状态是什么？（已发布/待审核/草稿/已下线）
   - [ ] 最新版本是否包含 `bitable:app:readonly` 权限？
   - [ ] 版本发布时间是什么时候？（如果是刚发布的，可能需要等待几分钟）

3. **如果版本状态不是"已发布"**
   - 点击"创建版本"
   - 填写版本说明
   - 点击"申请线上发布"
   - 等待审核通过（企业自建应用可能需要管理员审核）

---

### 第三步：确认应用可用范围

1. **访问可用性设置**
   - URL: https://open.feishu.cn/app/cli_a989e0fcbd7f100c/secureset/availability

2. **检查设置**
   - [ ] 应用是否已启用？
   - [ ] 可用范围是"全员可用"还是"部分成员"？
   - [ ] 您的账号是否在可用范围内？

---

### 第四步：确认多维表格授权（⭐最关键）

#### 方法A：通过多维表格界面

1. **打开多维表格**
   - 在飞书中打开"降噪内容库"
   - 或访问浏览器地址：`https://[你的域名].feishu.cn/base/FD0uwEbNTiWpgBkOSc1cxBslnQc`

2. **添加机器人协作者**
   - 点击右上角的**"协作"**、**"分享"**或**"成员管理"**按钮
   - 在搜索框中输入：
     - 应用名称："降噪内容管理"
     - 或 App ID："cli_a989e0fcbd7f100c"
     - 或直接搜索"机器人"或"应用"

3. **设置权限**
   - 找到应用后，点击添加
   - 权限至少设置为：**可查看** 或 **可编辑**
   - 保存

4. **验证**
   - [ ] 协作者列表中能看到您的应用吗？
   - [ ] 应用图标旁边有"机器人"或"Bot"标识吗？

#### 方法B：通过飞书管理后台（需要管理员权限）

1. **访问管理后台**
   - https://[你的域名].feishu.cn/admin

2. **工作台 → 多维表格**
   - 找到"降噪内容库"
   - 点击设置或权限管理
   - 添加机器人/应用访问权限

---

### 第五步：验证 Base ID 和 Table ID

1. **打开多维表格**
   - 在飞书中打开"降噪内容库"

2. **查看浏览器地址栏**
   - 格式应该是：`https://xxx.feishu.cn/base/{BASE_ID}?table={TABLE_ID}&view={VIEW_ID}`
   - 示例：`https://xxx.feishu.cn/base/FD0uwEbNTiWpgBkOSc1cxBslnQc?table=tblOJWanaihU2lvu&view=vew123`

3. **对比配置**
   - [ ] Base ID 是否匹配：`FD0uwEbNTiWpgBkOSc1cxBslnQc`
   - [ ] Table ID 是否匹配：`tblOJWanaihU2lvu`

4. **注意事项**
   - Base ID 通常以 `basc` 或其他前缀开头
   - Table ID 通常以 `tbl` 开头
   - 如果您的 Base ID 不是以 `basc` 开头而是其他格式，请告诉我

---

### 第六步：检查企业/团队设置

1. **确认是否是企业自建应用**
   - 如果是，可能需要企业管理员审核应用权限变更

2. **检查企业安全策略**
   - 企业可能有额外的安全策略限制API访问

3. **联系企业IT管理员**
   - 确认是否有额外的权限限制

---

### 第七步：等待权限生效

如果以上步骤都确认无误：

1. **清除缓存**
   - 退出飞书客户端重新登录
   - 清除浏览器缓存

2. **等待生效**
   - 权限变更可能需要 5-10 分钟生效
   - 版本发布可能需要更长时间

3. **重启服务**
   ```bash
   cd jiangzao
   # 重新测试
   node scripts/test-feishu.js
   ```

---

## 常见问题解答

### Q1: 我已经添加了权限并发布版本，为什么还报错？

**A**: 最常见的原因是**多维表格未授权给应用**（第四步）。即使应用有全局权限，多维表格本身也需要将应用添加为协作者。

### Q2: 我找不到"协作"按钮怎么办？

**A**:
1. 确保您有该多维表格的管理权限
2. 尝试点击右上角的"..."或"更多"按钮
3. 查找"成员管理"、"分享设置"等类似入口
4. 如果都找不到，请联系表格创建者添加

### Q3: 搜索不到我的应用怎么办？

**A**:
1. 确认应用状态为"已启用"
2. 尝试输入完整的 App ID：cli_a989e0fcbd7f100c
3. 检查应用可用范围设置
4. 尝试搜索"机器人"或"Bot"分类

### Q4: Base ID 的格式对吗？

**A**:
- 标准格式应该是 `bascXXXXXXXXXXXX`（以 basc 开头）
- 您的 `FD0uwEbNTiWpgBkOSc1cxBslnQc` 格式较特殊
- 请从浏览器地址栏重新确认 Base ID

### Q5: 如何确认应用已成为多维表格协作者？

**A**:
1. 打开多维表格
2. 查看协作者/成员列表
3. 应该能看到您的应用，图标旁边有"机器人"或"Bot"标识
4. 如果看不到，说明未成功添加

---

## 请提供以下信息

为了帮您更好地排查问题，请提供：

1. **权限管理页面截图**
   - 显示 bitable 相关权限的状态

2. **版本管理页面截图**
   - 显示最新版本的状态和权限列表

3. **多维表格浏览器地址栏截图**
   - 完整的 URL，包含 Base ID 和 Table ID

4. **协作者列表截图**（如果能看到的话）
   - 显示多维表格的协作成员

5. **告诉我**
   - 您的飞书账号类型：个人用户 / 企业用户
   - 应用类型：企业自建应用 / 测试应用
   - 您是否是企业管理员

有了这些信息，我可以更准确地帮您定位问题！
