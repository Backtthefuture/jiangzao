# é™å™ªå¹³å°æ”¯ä»˜ç³»ç»Ÿé›†æˆæ–¹æ¡ˆï¼ˆä¿®è®¢ç¨¿ï¼‰

> **ç‰ˆæœ¬**: V1.3.1
> **åˆ›å»ºæ—¥æœŸ**: 2025-11-04
> **æ”¯ä»˜ç½‘å…³**: Z-Pay (https://zpayz.cn/)
> **ç›®æ ‡**: é›†æˆä¼šå‘˜ä»˜è´¹ç³»ç»Ÿï¼Œå®ç°æ— é™é˜…è¯»æƒç›Š

---

## ç›®å½•

1. [ç³»ç»Ÿæ¶æ„æ¦‚è§ˆ](#ç³»ç»Ÿæ¶æ„æ¦‚è§ˆ)
2. [æ•°æ®åº“è®¾è®¡](#æ•°æ®åº“è®¾è®¡)
3. [ä¼šå‘˜å¥—é¤ä½“ç³»](#ä¼šå‘˜å¥—é¤ä½“ç³»)
4. [æ”¯ä»˜æµç¨‹è®¾è®¡](#æ”¯ä»˜æµç¨‹è®¾è®¡)
5. [å‰ç«¯é¡µé¢åŸå‹](#å‰ç«¯é¡µé¢åŸå‹)
6. [æŠ€æœ¯å®ç°æ–¹æ¡ˆ](#æŠ€æœ¯å®ç°æ–¹æ¡ˆ)
7. [API æ¥å£è®¾è®¡](#api-æ¥å£è®¾è®¡)
8. [å®‰å…¨æœºåˆ¶](#å®‰å…¨æœºåˆ¶)
9. [å®æ–½æ­¥éª¤](#å®æ–½æ­¥éª¤)
10. [æµ‹è¯•è®¡åˆ’](#æµ‹è¯•è®¡åˆ’)
11. [è¿ç»´ç›‘æ§](#è¿ç»´ç›‘æ§)

---

## ç³»ç»Ÿæ¶æ„æ¦‚è§ˆï¼ˆå¯¹é½ V1.2.2 è®¿é—®æ§åˆ¶ï¼‰

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                           é™å™ªå¹³å° V1.3.0                             â”‚
â”‚                        (æ”¯ä»˜+ä¼šå‘˜ç³»ç»Ÿé›†æˆ)                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   åŒ¿åç”¨æˆ·    â”‚         â”‚   ç™»å½•ç”¨æˆ·    â”‚         â”‚   ä¼šå‘˜ç”¨æˆ·    â”‚
â”‚  3ç¯‡/æœˆé™åˆ¶   â”‚         â”‚  10ç¯‡/æœˆé™åˆ¶  â”‚         â”‚   æ— é™é˜…è¯»    â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚                        â”‚                        â”‚
       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                â”‚
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚   å†…å®¹è®¿é—®æ§åˆ¶å±‚        â”‚
                    â”‚   (lib/access.ts)      â”‚
                    â”‚  + ä¼šå‘˜æƒç›Šæ£€æŸ¥(æ–°å¢)   â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                â”‚
       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
       â”‚                        â”‚                        â”‚
   â”Œâ”€â”€â”€â–¼â”€â”€â”€â”€â”            â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”
   â”‚ Feishu â”‚            â”‚  Supabase   â”‚         â”‚   SQLite    â”‚
   â”‚ å†…å®¹æº  â”‚            â”‚  ç”¨æˆ·/ä¼šå‘˜   â”‚         â”‚   åˆ†ææ•°æ®   â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                â”‚
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚      æ”¯ä»˜ç³»ç»Ÿå±‚         â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                â”‚
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚     Z-Pay ç½‘å…³         â”‚
                    â”‚  (å¾®ä¿¡/æ”¯ä»˜å®)          â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜


æ”¯ä»˜æµç¨‹æ¶æ„:
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

  ç”¨æˆ·ç«¯                    æœåŠ¡ç«¯                    Z-Pay
  â”€â”€â”€â”€â”€                    â”€â”€â”€â”€â”€                    â”€â”€â”€â”€â”€

    â”‚                        â”‚                        â”‚
    â”‚  1. é€‰æ‹©å¥—é¤            â”‚                        â”‚
    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                        â”‚
    â”‚                        â”‚  2. ç”Ÿæˆè®¢å•å·          â”‚
    â”‚                        â”‚     åˆ›å»ºè®¢å•è®°å½•        â”‚
    â”‚                        â”‚     (status=pending)   â”‚
    â”‚                        â”‚                        â”‚
    â”‚                        â”‚  3. è®¡ç®—ç­¾å            â”‚
    â”‚                        â”‚     æ‹¼æ¥æ”¯ä»˜å‚æ•°        â”‚
    â”‚                        â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚  submit.php/mapi.php
    â”‚                        â”‚                        â”‚
    â”‚  4. é‡å®šå‘åˆ°æ”¯ä»˜é¡µ       â”‚<â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€â”‚  è¿”å›æ”¯ä»˜URL
    â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚   (æ”¯ä»˜URL)             â”‚
    â”‚                        â”‚                        â”‚
    â”‚  5. æ‰«ç æ”¯ä»˜            â”‚                        â”‚
    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
    â”‚                        â”‚                        â”‚
    â”‚                        â”‚  6. å¼‚æ­¥å›è°ƒ            â”‚
    â”‚                        â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
    â”‚                        â”‚     (notify_url)       â”‚
    â”‚                        â”‚                        â”‚
    â”‚                        â”‚  7. éªŒè¯ç­¾å            â”‚
    â”‚                        â”‚     æ›´æ–°è®¢å•çŠ¶æ€        â”‚
    â”‚                        â”‚     (status=paid)      â”‚
    â”‚                        â”‚                        â”‚
    â”‚                        â”‚  8. æ¿€æ´»ä¼šå‘˜            â”‚
    â”‚                        â”‚     å†™å…¥user_membershipsâ”‚
    â”‚                        â”‚                        â”‚
    â”‚                        â”‚  9. è¿”å›"success"       â”‚
    â”‚                        â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
    â”‚                        â”‚                        â”‚
    â”‚  10. å‰ç«¯è½®è¯¢è®¢å•çŠ¶æ€    â”‚                        â”‚
    â”‚     (æ¯2ç§’æŸ¥è¯¢ä¸€æ¬¡)      â”‚                        â”‚
    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                        â”‚
    â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚                        â”‚
    â”‚    (status=paid)       â”‚                        â”‚
    â”‚                        â”‚                        â”‚
    â”‚  11. è·³è½¬æˆåŠŸé¡µ         â”‚                        â”‚
    â”‚     æ˜¾ç¤ºä¼šå‘˜æƒç›Š        â”‚                        â”‚
    â”‚                        â”‚                        â”‚

```

---

## æ•°æ®åº“è®¾è®¡

### 1. è®¢å•è¡¨ (`orders`)

ç”¨äºå­˜å‚¨æ‰€æœ‰æ”¯ä»˜è®¢å•è®°å½•ï¼Œæ”¯æŒè®¢å•æŸ¥è¯¢ã€çŠ¶æ€è·Ÿè¸ªå’Œå¯¹è´¦ã€‚

```sql
-- ============================================================================
-- è®¢å•è¡¨è®¾è®¡ (Supabase PostgreSQL)
-- ============================================================================

-- ä½¿ç”¨ ENUM å¼ºçº¦æŸè®¢å•çŠ¶æ€
DO $$ BEGIN
  CREATE TYPE public.order_status AS ENUM ('pending', 'paid', 'completed', 'failed', 'refunded');
EXCEPTION WHEN duplicate_object THEN NULL; END $$;

CREATE TABLE IF NOT EXISTS public.orders (
  -- ä¸»é”®
  id UUID DEFAULT gen_random_uuid() PRIMARY KEY,

  -- è®¢å•ä¿¡æ¯
  order_id TEXT NOT NULL UNIQUE,                -- å•†æˆ·è®¢å•å· (out_trade_no)
  trade_no TEXT,                                 -- Z-Pay äº¤æ˜“å·

  -- ç”¨æˆ·ä¿¡æ¯ï¼ˆå¿…é¡»ç™»å½•ä¸‹å•ï¼‰
  user_id UUID NOT NULL REFERENCES auth.users(id),
  user_email TEXT,                               -- ç”¨æˆ·é‚®ç®± (å†—ä½™å­—æ®µ,ä¾¿äºæŸ¥è¯¢)

  -- å•†å“ä¿¡æ¯
  product_type TEXT NOT NULL,                    -- å•†å“ç±»å‹: monthly/yearly/lifetime
  product_name TEXT NOT NULL,                    -- å•†å“åç§°: æœˆä¼šå‘˜/å¹´ä¼šå‘˜/ç»ˆèº«ä¼šå‘˜
  amount NUMERIC(10, 2) NOT NULL,                -- è®¢å•é‡‘é¢ (å•ä½: å…ƒ)

  -- æ”¯ä»˜ä¿¡æ¯
  payment_method TEXT NOT NULL,                  -- æ”¯ä»˜æ–¹å¼: alipay/wxpay
  status public.order_status NOT NULL DEFAULT 'pending',

  -- ä¼šå‘˜æ—¶é•¿ä¿¡æ¯
  membership_duration_days INTEGER,              -- ä¼šå‘˜æ—¶é•¿å¤©æ•° (NULL è¡¨ç¤ºç»ˆèº«)
  membership_start_date TIMESTAMP WITH TIME ZONE,-- ä¼šå‘˜èµ·å§‹æ—¥æœŸ
  membership_end_date TIMESTAMP WITH TIME ZONE,  -- ä¼šå‘˜ç»“æŸæ—¥æœŸ (NULL è¡¨ç¤ºç»ˆèº«)

  -- å›è°ƒä¿¡æ¯
  callback_received_at TIMESTAMP WITH TIME ZONE, -- å›è°ƒæ¥æ”¶æ—¶é—´
  callback_data JSONB,                           -- å›è°ƒåŸå§‹æ•°æ® (ç”¨äºå¯¹è´¦)

  -- å¤‡æ³¨
  note TEXT,                                     -- è®¢å•å¤‡æ³¨
  client_ip TEXT,                                -- å®¢æˆ·ç«¯IP

  -- æ—¶é—´æˆ³
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW() NOT NULL,
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW() NOT NULL
);

-- ============================================================================
-- ç´¢å¼•ä¼˜åŒ–
-- ============================================================================

-- è®¢å•å·ç´¢å¼• (ç”¨äºå¿«é€ŸæŸ¥è¯¢å’Œé˜²é‡)
CREATE UNIQUE INDEX IF NOT EXISTS idx_orders_order_id
  ON public.orders (order_id);

-- ç”¨æˆ·è®¢å•ç´¢å¼• (ç”¨äºæŸ¥è¯¢ç”¨æˆ·çš„è®¢å•å†å²)
CREATE INDEX IF NOT EXISTS idx_orders_user_id
  ON public.orders (user_id);

-- çŠ¶æ€ç´¢å¼• (ç”¨äºç­›é€‰å¾…å¤„ç†è®¢å•)
CREATE INDEX IF NOT EXISTS idx_orders_status
  ON public.orders (status);

-- æ—¶é—´ç´¢å¼• (ç”¨äºç»Ÿè®¡å’Œå¯¹è´¦)
CREATE INDEX IF NOT EXISTS idx_orders_created_at
  ON public.orders (created_at DESC);

-- Z-Pay äº¤æ˜“å·ç´¢å¼• (ç”¨äºå›è°ƒæŸ¥è¯¢)
CREATE INDEX IF NOT EXISTS idx_orders_trade_no
  ON public.orders (trade_no);

-- é¿å…é‡å¤ç»‘å®šåŒä¸€äº¤æ˜“å·ï¼ˆå…è®¸ NULLï¼Œå¤šå›è°ƒå¹‚ç­‰ï¼‰
CREATE UNIQUE INDEX IF NOT EXISTS idx_orders_trade_no_unique
  ON public.orders (trade_no)
  WHERE trade_no IS NOT NULL;

-- ============================================================================
-- è¡Œçº§å®‰å…¨ç­–ç•¥ (RLS)
-- ============================================================================

-- å¯ç”¨ RLS
ALTER TABLE public.orders ENABLE ROW LEVEL SECURITY;

-- æ¸…ç†æ—§ç­–ç•¥
DROP POLICY IF EXISTS "Users can view own orders" ON public.orders;
DROP POLICY IF EXISTS "Service role can manage orders" ON public.orders;

-- ç”¨æˆ·åªèƒ½æŸ¥çœ‹è‡ªå·±çš„è®¢å•
CREATE POLICY "Users can view own orders"
  ON public.orders
  FOR SELECT
  USING (auth.uid() = user_id);

-- æœåŠ¡è§’è‰²å¯ä»¥ç®¡ç†æ‰€æœ‰è®¢å• (ç”¨äº API è·¯ç”±)
CREATE POLICY "Service role can manage orders"
  ON public.orders
  FOR ALL
  USING (auth.role() = 'service_role')
  WITH CHECK (auth.role() = 'service_role');

-- å¯é€‰: ç”¨æˆ·è‡ªåŠ©åˆ›å»ºè®¢å•ï¼ˆå¦‚æœ API ä¸ä½¿ç”¨ service roleï¼‰
DROP POLICY IF EXISTS "Users can create own orders" ON public.orders;
CREATE POLICY "Users can create own orders"
  ON public.orders
  FOR INSERT
  WITH CHECK (auth.uid() = user_id AND status = 'pending');

-- ============================================================================
-- è§¦å‘å™¨: è‡ªåŠ¨æ›´æ–° updated_at
-- ============================================================================

CREATE OR REPLACE FUNCTION public.update_orders_updated_at()
RETURNS TRIGGER AS $$
BEGIN
  NEW.updated_at = NOW();
  RETURN NEW;
END;
$$ LANGUAGE plpgsql;

DROP TRIGGER IF EXISTS trigger_orders_updated_at ON public.orders;
CREATE TRIGGER trigger_orders_updated_at
  BEFORE UPDATE ON public.orders
  FOR EACH ROW
  EXECUTE FUNCTION public.update_orders_updated_at();

-- ============================================================================
-- æ³¨é‡Š
-- ============================================================================

COMMENT ON TABLE public.orders IS 'V1.3.0: æ”¯ä»˜è®¢å•è¡¨';
COMMENT ON COLUMN public.orders.order_id IS 'å•†æˆ·è®¢å•å· (å¯¹åº” Z-Pay out_trade_no)';
COMMENT ON COLUMN public.orders.trade_no IS 'Z-Pay äº¤æ˜“å·';
COMMENT ON COLUMN public.orders.status IS 'è®¢å•çŠ¶æ€: pending(å¾…æ”¯ä»˜), paid(å·²æ”¯ä»˜), completed(å·²å®Œæˆ), failed(å¤±è´¥), refunded(å·²é€€æ¬¾)';
COMMENT ON COLUMN public.orders.product_type IS 'å•†å“ç±»å‹: monthly(æœˆä¼šå‘˜), yearly(å¹´ä¼šå‘˜), lifetime(ç»ˆèº«ä¼šå‘˜)';
COMMENT ON COLUMN public.orders.callback_data IS 'å›è°ƒåŸå§‹æ•°æ® (JSONB æ ¼å¼,ç”¨äºå¯¹è´¦å’Œé—®é¢˜æ’æŸ¥)';

-- ============================================================================
-- æ‰§è¡Œå®Œæˆæç¤º
-- ============================================================================
SELECT 'Migration: Orders table created successfully!' as status;
```

### 2. ä¼šå‘˜è¡¨ (å·²å­˜åœ¨)

å·²åœ¨ `supabase_migration_v1.3.0_membership.sql` ä¸­åˆ›å»ºï¼Œæ— éœ€ä¿®æ”¹ï¼š

```sql
-- è¡¨: public.user_memberships
-- å­—æ®µ:
--   - user_id: UUID (ä¸»é”®)
--   - tier: membership_tier (free/monthly/yearly/lifetime)
--   - expires_at: TIMESTAMP (ä¼šå‘˜åˆ°æœŸæ—¶é—´, NULL è¡¨ç¤ºæ°¸ä¹…)
--   - created_at: TIMESTAMP
--   - updated_at: TIMESTAMP
```

### 3. æ•°æ®è¡¨å…³ç³»å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚       auth.users               â”‚
â”‚  (Supabase å†…ç½®)                â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€         â”‚
â”‚  â€¢ id (UUID)                   â”‚
â”‚  â€¢ email                       â”‚
â”‚  â€¢ created_at                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
            â”‚
            â”‚ 1:1
            â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   public.user_memberships      â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€    â”‚
â”‚  â€¢ user_id (PK, FK)            â”‚
â”‚  â€¢ tier (ENUM)                 â”‚
â”‚  â€¢ expires_at                  â”‚
â”‚  â€¢ created_at                  â”‚
â”‚  â€¢ updated_at                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
            â”‚
            â”‚ 1:N
            â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚     public.orders              â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€    â”‚
â”‚  â€¢ id (UUID, PK)               â”‚
â”‚  â€¢ order_id (UNIQUE)           â”‚
â”‚  â€¢ user_id (FK)                â”‚
â”‚  â€¢ product_type                â”‚
â”‚  â€¢ amount                      â”‚
â”‚  â€¢ status                      â”‚
â”‚  â€¢ created_at                  â”‚
â”‚  â€¢ ...                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ä¼šå‘˜å¥—é¤ä½“ç³»

### å¥—é¤å®šä¹‰

| å¥—é¤ç±»å‹ | ä»·æ ¼ | æœ‰æ•ˆæœŸ | æœˆå‡æˆæœ¬ | é˜…è¯»æƒç›Š | æ¨èåº¦ |
|---------|------|--------|---------|---------|--------|
| **æœˆä¼šå‘˜** | Â¥19.9 | 30å¤© | Â¥19.9 | æ— é™é˜…è¯» | â­â­â­ |
| **å¹´ä¼šå‘˜** | Â¥198 | 365å¤© | Â¥16.5 | æ— é™é˜…è¯» | â­â­â­â­â­ (æ¨è) |
| **ç»ˆèº«ä¼šå‘˜** | Â¥599 | æ°¸ä¹… | - | æ— é™é˜…è¯» + æœªæ¥æ–°åŠŸèƒ½ | â­â­â­â­ |

### æƒç›Šå¯¹æ¯”

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        æƒç›Šå¯¹æ¯”è¡¨                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚   åŠŸèƒ½       â”‚ åŒ¿åç”¨æˆ· â”‚ ç™»å½•ç”¨æˆ· â”‚ æœˆä¼šå‘˜   â”‚ å¹´ä¼šå‘˜   â”‚ç»ˆèº«ä¼šå‘˜ â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ æœˆåº¦é˜…è¯»ä¸Šé™ â”‚  3 ç¯‡   â”‚  10 ç¯‡  â”‚  æ— é™   â”‚  æ— é™   â”‚  æ— é™   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ å†å²è®°å½•æŸ¥çœ‹ â”‚    âœ—    â”‚    âœ“    â”‚    âœ“    â”‚    âœ“    â”‚    âœ“    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ é˜…è¯»ç»Ÿè®¡     â”‚    âœ—    â”‚    âœ“    â”‚    âœ“    â”‚    âœ“    â”‚    âœ“    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ ä¼šå‘˜ä¸“å±æ ‡è¯† â”‚    âœ—    â”‚    âœ—    â”‚    âœ“    â”‚    âœ“    â”‚    âœ“    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ æœªæ¥æ–°åŠŸèƒ½   â”‚    âœ—    â”‚    âœ—    â”‚    âœ—    â”‚    âœ—    â”‚    âœ“    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ ä¼˜æƒ åŠ›åº¦     â”‚    -    â”‚    -    â”‚   1.0x  â”‚  1.2x   â”‚  2.0x  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### å¥—é¤é…ç½® (é…ç½®æ–‡ä»¶)

```typescript
// config/membership.ts
export const MEMBERSHIP_PLANS = {
  monthly: {
    type: 'monthly',
    name: 'æœˆä¼šå‘˜',
    price: 19.9,
    durationDays: 30,
    description: 'è¿ç»­30å¤©æ— é™é˜…è¯»',
    features: ['æ— é™é˜…è¯»', 'é˜…è¯»ç»Ÿè®¡', 'ä¼šå‘˜æ ‡è¯†'],
  },
  yearly: {
    type: 'yearly',
    name: 'å¹´ä¼šå‘˜',
    price: 198,
    durationDays: 365,
    description: 'ä¸€å¹´æ— é™é˜…è¯»ï¼Œç›¸å½“äºæ¯æœˆÂ¥16.5',
    features: ['æ— é™é˜…è¯»', 'é˜…è¯»ç»Ÿè®¡', 'ä¼šå‘˜æ ‡è¯†', 'æœ€ä¼˜æƒ ä»·'],
    recommended: true, // æ¨èæ ‡è¯†
  },
  lifetime: {
    type: 'lifetime',
    name: 'ç»ˆèº«ä¼šå‘˜',
    price: 599,
    durationDays: null, // null è¡¨ç¤ºæ°¸ä¹…
    description: 'æ°¸ä¹…æ— é™é˜…è¯»ï¼Œæœªæ¥æ–°åŠŸèƒ½ä¼˜å…ˆä½“éªŒ',
    features: ['æ— é™é˜…è¯»', 'é˜…è¯»ç»Ÿè®¡', 'ä¼šå‘˜æ ‡è¯†', 'æœªæ¥æ–°åŠŸèƒ½', 'ä¸€æ¬¡ä»˜è´¹æ°¸ä¹…ä½¿ç”¨'],
  },
} as const;

export type MembershipPlanType = keyof typeof MEMBERSHIP_PLANS;
```

---

## æ”¯ä»˜æµç¨‹è®¾è®¡

### 1. å®Œæ•´æµç¨‹å›¾

```
ç”¨æˆ·é€‰æ‹©å¥—é¤
     â”‚
     â–¼
åˆ›å»ºè®¢å• (POST /api/payment/create-order)
     â”‚
     â”œâ”€> æ£€æŸ¥ç”¨æˆ·ç™»å½•çŠ¶æ€ (å¿…é¡»ç™»å½•)
     â”‚
     â”œâ”€> ç”Ÿæˆå”¯ä¸€è®¢å•å· (JZ_20251104_xxxxx)
     â”‚
     â”œâ”€> å†™å…¥ orders è¡¨ (status=pending)
     â”‚
     â”œâ”€> è®¡ç®— MD5 ç­¾å
     â”‚
     â””â”€> è¿”å›æ”¯ä»˜å‚æ•°
           â”‚
           â–¼
å‰ç«¯è·³è½¬åˆ° Z-Pay æ”¯ä»˜é¡µ
     â”‚
     â”œâ”€> ç”¨æˆ·æ‰«ç æ”¯ä»˜ (å¾®ä¿¡/æ”¯ä»˜å®)
     â”‚
     â””â”€> æ”¯ä»˜æˆåŠŸ
           â”‚
           â–¼
Z-Pay å¼‚æ­¥å›è°ƒ (POST /api/payment/callback)
     â”‚
     â”œâ”€> éªŒè¯ç­¾å
     â”‚
     â”œâ”€> éªŒè¯é‡‘é¢
     â”‚
     â”œâ”€> éªŒè¯è®¢å•çŠ¶æ€ (é˜²æ­¢é‡å¤å›è°ƒ)
     â”‚
     â”œâ”€> æ›´æ–°è®¢å•çŠ¶æ€ (pending â†’ paid)
     â”‚
     â”œâ”€> æ¿€æ´»/å»¶é•¿ä¼šå‘˜ (å†™å…¥ user_memberships)
     â”‚       â”‚
     â”‚       â”œâ”€> å¦‚æœæ˜¯æ–°ä¼šå‘˜: INSERT
     â”‚       â”‚
     â”‚       â””â”€> å¦‚æœæ˜¯ç»­è´¹: UPDATE (å»¶é•¿æ—¶é—´)
     â”‚
     â””â”€> è¿”å› "success" ç»™ Z-Pay
           â”‚
           â–¼
å‰ç«¯è½®è¯¢è®¢å•çŠ¶æ€ (GET /api/payment/check-status/{orderId})
     â”‚
     â”œâ”€> æ¯ 2 ç§’æŸ¥è¯¢ä¸€æ¬¡
     â”‚
     â”œâ”€> æœ€å¤šè½®è¯¢ 30 æ¬¡ (60ç§’)
     â”‚
     â””â”€> æ£€æµ‹åˆ° status=paid
           â”‚
           â–¼
è·³è½¬åˆ°æ”¯ä»˜æˆåŠŸé¡µ (/payment/result?order_id=xxx)
     â”‚
     â””â”€> æ˜¾ç¤ºä¼šå‘˜æƒç›Š
           â”‚
           â””â”€> å¼•å¯¼ç”¨æˆ·æŸ¥çœ‹ä¼šå‘˜ä¸­å¿ƒ
```

### 2. çŠ¶æ€æœºè®¾è®¡

```
è®¢å•çŠ¶æ€æµè½¬:
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

  pending â”€â”€â”€â”€â”€â”€> paid â”€â”€â”€â”€â”€â”€> completed
     â”‚                             â”‚
     â”‚                             â”‚
     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€> failed           â”‚
                                   â”‚
  paid â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€> refunded <â”€â”€â”€â”€â”€â”€â”˜


çŠ¶æ€è¯´æ˜:
â”€â”€â”€â”€â”€â”€â”€â”€â”€
â€¢ pending: è®¢å•å·²åˆ›å»º,ç­‰å¾…æ”¯ä»˜
â€¢ paid: æ”¯ä»˜æˆåŠŸ,ç­‰å¾…ä¼šå‘˜æ¿€æ´»
â€¢ completed: ä¼šå‘˜å·²æ¿€æ´»,è®¢å•å®Œæˆ
â€¢ failed: æ”¯ä»˜å¤±è´¥æˆ–è¶…æ—¶
â€¢ refunded: å·²é€€æ¬¾

çŠ¶æ€è½¬æ¢è§„åˆ™:
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
1. pending â†’ paid: Z-Pay å›è°ƒæˆåŠŸ
2. paid â†’ completed: ä¼šå‘˜æ¿€æ´»æˆåŠŸ
3. pending â†’ failed: æ”¯ä»˜è¶…æ—¶ (24å°æ—¶)
4. paid/completed â†’ refunded: æ‰‹åŠ¨é€€æ¬¾

é…å¥—ä»»åŠ¡ï¼š
- æ¯æ—¥å®šæ—¶ä»»åŠ¡ï¼ˆæˆ–åå°ç®¡ç†æ“ä½œï¼‰å°†è¶…è¿‡ 24 å°æ—¶æœªæ”¯ä»˜çš„è®¢å•æ ‡è®°ä¸º `failed`ã€‚
- ä»…å…è®¸ `pending` â†’ `paid` çš„å›è°ƒå†™å…¥ï¼Œé¿å…é‡å¤å›è°ƒå¼•å‘çš„å¤šæ¬¡æ¿€æ´»ã€‚
```

---

## å‰ç«¯é¡µé¢åŸå‹

### 1. å®šä»·é¡µ (`/pricing`)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                                                         â”‚
â”‚                          ğŸ¯ é€‰æ‹©é€‚åˆä½ çš„ä¼šå‘˜å¥—é¤                          â”‚
â”‚                                                                         â”‚
â”‚     ä½“éªŒæ— é™é˜…è¯»,æ·±åº¦å­¦ä¹  AI è¡Œä¸šçš„æ¯ä¸€ç¯‡ç²¾é€‰è®¿è°ˆ                          â”‚
â”‚                                                                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”‚
â”‚  â”‚   æœˆä¼šå‘˜        â”‚  â”‚   å¹´ä¼šå‘˜  æ¨è  â”‚  â”‚   ç»ˆèº«ä¼šå‘˜      â”‚           â”‚
â”‚  â”‚                â”‚  â”‚                â”‚  â”‚                â”‚           â”‚
â”‚  â”‚   Â¥19.9       â”‚  â”‚   Â¥198        â”‚  â”‚   Â¥599        â”‚           â”‚
â”‚  â”‚   /æœˆ          â”‚  â”‚   /å¹´          â”‚  â”‚   æ°¸ä¹…         â”‚           â”‚
â”‚  â”‚                â”‚  â”‚                â”‚  â”‚                â”‚           â”‚
â”‚  â”‚ âœ“ æ— é™é˜…è¯»      â”‚  â”‚ âœ“ æ— é™é˜…è¯»      â”‚  â”‚ âœ“ æ— é™é˜…è¯»      â”‚           â”‚
â”‚  â”‚ âœ“ é˜…è¯»ç»Ÿè®¡      â”‚  â”‚ âœ“ é˜…è¯»ç»Ÿè®¡      â”‚  â”‚ âœ“ é˜…è¯»ç»Ÿè®¡      â”‚           â”‚
â”‚  â”‚ âœ“ ä¼šå‘˜æ ‡è¯†      â”‚  â”‚ âœ“ ä¼šå‘˜æ ‡è¯†      â”‚  â”‚ âœ“ ä¼šå‘˜æ ‡è¯†      â”‚           â”‚
â”‚  â”‚                â”‚  â”‚ âœ“ çœ Â¥40.8     â”‚  â”‚ âœ“ æœªæ¥æ–°åŠŸèƒ½    â”‚           â”‚
â”‚  â”‚                â”‚  â”‚ (ç›¸å½“Â¥16.5/æœˆ) â”‚  â”‚ âœ“ ä¸€æ¬¡ä»˜è´¹      â”‚           â”‚
â”‚  â”‚                â”‚  â”‚                â”‚  â”‚                â”‚           â”‚
â”‚  â”‚ [ç«‹å³è®¢é˜…]      â”‚  â”‚ [ç«‹å³è®¢é˜…]      â”‚  â”‚ [ç«‹å³è®¢é˜…]      â”‚           â”‚
â”‚  â”‚                â”‚  â”‚                â”‚  â”‚                â”‚           â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â”‚
â”‚                                                                         â”‚
â”‚  æ”¯ä»˜æ–¹å¼: ğŸ’³ æ”¯ä»˜å®  /  ğŸ’š å¾®ä¿¡æ”¯ä»˜                                      â”‚
â”‚                                                                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                         â”‚
â”‚  ğŸ’¡ æ¸©é¦¨æç¤º:                                                            â”‚
â”‚  â€¢ ç™»å½•åæ‰èƒ½è´­ä¹°ä¼šå‘˜                                                     â”‚
â”‚  â€¢ æ”¯ä»˜æˆåŠŸåä¼šå‘˜ç«‹å³ç”Ÿæ•ˆ                                                 â”‚
â”‚  â€¢ å¦‚æœ‰é—®é¢˜è¯·è”ç³»å®¢æœ                                                     â”‚
â”‚                                                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2. æ”¯ä»˜é¡µ (Z-Pay è·³è½¬é¡µ)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                                                         â”‚
â”‚                          ğŸ” å®‰å…¨æ”¯ä»˜                                     â”‚
â”‚                                                                         â”‚
â”‚  è®¢å•å·: JZ_20251104_1234567890                                         â”‚
â”‚  å•†å“: å¹´ä¼šå‘˜                                                            â”‚
â”‚  é‡‘é¢: Â¥198.00                                                          â”‚
â”‚                                                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                           â”‚
â”‚  â”‚                                         â”‚                           â”‚
â”‚  â”‚         [æ”¯ä»˜å®/å¾®ä¿¡ äºŒç»´ç ]              â”‚                           â”‚
â”‚  â”‚                                         â”‚                           â”‚
â”‚  â”‚         â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ               â”‚                           â”‚
â”‚  â”‚         â–ˆâ–ˆ â–„â–„â–„â–„â–„ â–ˆâ–€â–ˆâ–€ â–ˆâ–ˆ               â”‚                           â”‚
â”‚  â”‚         â–ˆâ–ˆ â–ˆ   â–ˆ â–ˆ â–€  â–ˆâ–ˆ               â”‚                           â”‚
â”‚  â”‚         â–ˆâ–ˆ â–ˆâ–„â–„â–„â–ˆ â–ˆ â–ˆ â–ˆâ–ˆâ–ˆ               â”‚                           â”‚
â”‚  â”‚         â–ˆâ–ˆâ–„â–„â–„â–„â–„â–„â–„â–ˆâ–„â–€â–„â–€ â–ˆâ–ˆ               â”‚                           â”‚
â”‚  â”‚         â–ˆâ–ˆâ–€â–ˆâ–ˆâ–€â–€â–€â–€â–€â–€ â–„â–ˆâ–ˆâ–ˆ               â”‚                           â”‚
â”‚  â”‚         â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ               â”‚                           â”‚
â”‚  â”‚                                         â”‚                           â”‚
â”‚  â”‚    è¯·ä½¿ç”¨æ”¯ä»˜å®/å¾®ä¿¡æ‰«ç æ”¯ä»˜              â”‚                           â”‚
â”‚  â”‚                                         â”‚                           â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                           â”‚
â”‚                                                                         â”‚
â”‚  æ”¯ä»˜å®Œæˆå,é¡µé¢å°†è‡ªåŠ¨è·³è½¬...                                             â”‚
â”‚  (å¦‚æœªè‡ªåŠ¨è·³è½¬,è¯·ç‚¹å‡» [è¿”å›å•†æˆ·])                                         â”‚
â”‚                                                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 3. æ”¯ä»˜ç»“æœé¡µ (`/payment/result?order_id=xxx`)

#### æˆåŠŸé¡µé¢:

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                                                         â”‚
â”‚                          âœ… æ”¯ä»˜æˆåŠŸ!                                    â”‚
â”‚                                                                         â”‚
â”‚  æ­å–œä½ æˆä¸ºé™å™ªå¹³å°ä¼šå‘˜,ç°åœ¨å¯ä»¥æ— é™é˜…è¯»æ‰€æœ‰å†…å®¹äº†!                         â”‚
â”‚                                                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”‚
â”‚  â”‚  è®¢å•ä¿¡æ¯:                                              â”‚           â”‚
â”‚  â”‚  â€¢ è®¢å•å·: JZ_20251104_1234567890                       â”‚           â”‚
â”‚  â”‚  â€¢ å¥—é¤: å¹´ä¼šå‘˜                                         â”‚           â”‚
â”‚  â”‚  â€¢ é‡‘é¢: Â¥198.00                                       â”‚           â”‚
â”‚  â”‚  â€¢ æ”¯ä»˜æ—¶é—´: 2025-11-04 15:30:22                       â”‚           â”‚
â”‚  â”‚                                                         â”‚           â”‚
â”‚  â”‚  ä¼šå‘˜ä¿¡æ¯:                                              â”‚           â”‚
â”‚  â”‚  â€¢ ä¼šå‘˜ç±»å‹: å¹´ä¼šå‘˜                                     â”‚           â”‚
â”‚  â”‚  â€¢ ç”Ÿæ•ˆæ—¶é—´: 2025-11-04 15:30:22                       â”‚           â”‚
â”‚  â”‚  â€¢ åˆ°æœŸæ—¶é—´: 2026-11-04 15:30:22                       â”‚           â”‚
â”‚  â”‚  â€¢ å‰©ä½™å¤©æ•°: 365 å¤©                                     â”‚           â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â”‚
â”‚                                                                         â”‚
â”‚  [ å‰å¾€ä¼šå‘˜ä¸­å¿ƒ ]  [ å¼€å§‹é˜…è¯» ]                                           â”‚
â”‚                                                                         â”‚
â”‚  ğŸ’¡ å°è´´å£«:                                                              â”‚
â”‚  â€¢ ä¼šå‘˜æƒç›Šå·²ç«‹å³ç”Ÿæ•ˆ,å¯æ— é™é˜…è¯»æ‰€æœ‰å†…å®¹                                   â”‚
â”‚  â€¢ åœ¨ä¼šå‘˜ä¸­å¿ƒå¯æŸ¥çœ‹è®¢å•å†å²å’Œä¼šå‘˜çŠ¶æ€                                      â”‚
â”‚  â€¢ å¦‚æœ‰é—®é¢˜è¯·è”ç³»å®¢æœ                                                     â”‚
â”‚                                                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### å¤±è´¥é¡µé¢:

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                                                         â”‚
â”‚                          âŒ æ”¯ä»˜å¤±è´¥                                     â”‚
â”‚                                                                         â”‚
â”‚  å¾ˆæŠ±æ­‰,ä½ çš„æ”¯ä»˜æœªæˆåŠŸ,è¯·é‡è¯•                                             â”‚
â”‚                                                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”‚
â”‚  â”‚  è®¢å•å·: JZ_20251104_1234567890                         â”‚           â”‚
â”‚  â”‚  å¤±è´¥åŸå› : æ”¯ä»˜è¶…æ—¶ / ç”¨æˆ·å–æ¶ˆ / ä½™é¢ä¸è¶³                â”‚           â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â”‚
â”‚                                                                         â”‚
â”‚  [ é‡æ–°æ”¯ä»˜ ]  [ è¿”å›é¦–é¡µ ]                                              â”‚
â”‚                                                                         â”‚
â”‚  ğŸ’¡ éœ€è¦å¸®åŠ©?                                                            â”‚
â”‚  â€¢ æ£€æŸ¥æ”¯ä»˜å®/å¾®ä¿¡è´¦æˆ·ä½™é¢æ˜¯å¦å……è¶³                                         â”‚
â”‚  â€¢ ç¡®è®¤ç½‘ç»œè¿æ¥æ­£å¸¸                                                       â”‚
â”‚  â€¢ å¦‚ä»æœ‰é—®é¢˜è¯·è”ç³»å®¢æœ                                                   â”‚
â”‚                                                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 4. ä¼šå‘˜ä¸­å¿ƒ (`/user/membership`)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ä¼šå‘˜ä¸­å¿ƒ                                             [ ç”¨æˆ·é‚®ç®± â–¼ ]      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                         â”‚
â”‚  ğŸ‘¤ æˆ‘çš„ä¼šå‘˜                                                             â”‚
â”‚                                                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”‚
â”‚  â”‚                                                         â”‚           â”‚
â”‚  â”‚  å½“å‰ä¼šå‘˜: ğŸŒŸ å¹´ä¼šå‘˜                                     â”‚           â”‚
â”‚  â”‚  åˆ°æœŸæ—¶é—´: 2026-11-04                                   â”‚           â”‚
â”‚  â”‚  å‰©ä½™å¤©æ•°: 365 å¤©                                       â”‚           â”‚
â”‚  â”‚                                                         â”‚           â”‚
â”‚  â”‚  [ ç»­è´¹ ]  [ å‡çº§è‡³ç»ˆèº«ä¼šå‘˜ ]                            â”‚           â”‚
â”‚  â”‚                                                         â”‚           â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â”‚
â”‚                                                                         â”‚
â”‚  ğŸ“Š é˜…è¯»ç»Ÿè®¡                                                             â”‚
â”‚                                                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”‚
â”‚  â”‚ æœ¬æœˆé˜…è¯»     â”‚ å†å²æ€»è®¡     â”‚ æœ¬æœˆæ”¶è—     â”‚ é˜…è¯»æ—¶é•¿     â”‚           â”‚
â”‚  â”‚                                                         â”‚           â”‚
â”‚  â”‚    23 ç¯‡    â”‚   156 ç¯‡    â”‚    5 ç¯‡     â”‚   8.5 å°æ—¶  â”‚           â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â”‚
â”‚                                                                         â”‚
â”‚  ğŸ§¾ è®¢å•å†å²                                                             â”‚
â”‚                                                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ è®¢å•å·              â”‚ å•†å“    â”‚ é‡‘é¢    â”‚ çŠ¶æ€  â”‚ æ—¶é—´           â”‚   â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤   â”‚
â”‚  â”‚ JZ_20251104_123456  â”‚ å¹´ä¼šå‘˜  â”‚ Â¥198   â”‚ å·²å®Œæˆ â”‚ 2025-11-04     â”‚   â”‚
â”‚  â”‚ JZ_20240501_789012  â”‚ æœˆä¼šå‘˜  â”‚ Â¥19.9  â”‚ å·²å®Œæˆ â”‚ 2025-05-01     â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                         â”‚
â”‚  [ æŸ¥çœ‹æ›´å¤šè®¢å• ]                                                        â”‚
â”‚                                                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 5. ä¼šå‘˜æ ‡è¯†å±•ç¤º (å†…å®¹é¡µå¤´éƒ¨)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  [ Logo ]  é™å™ª                                    ğŸŒŸ å¹´ä¼šå‘˜  [ é‚®ç®± â–¼ ] â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                         â”‚
â”‚  âœ… ä½ æ˜¯ä¼šå‘˜ç”¨æˆ·,å¯æ— é™é˜…è¯»æ‰€æœ‰å†…å®¹                                        â”‚
â”‚  ä¼šå‘˜åˆ°æœŸæ—¶é—´: 2026-11-04 (å‰©ä½™ 365 å¤©) | [ æŸ¥çœ‹ä¼šå‘˜æƒç›Š ]                â”‚
â”‚                                                                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
```

---

## æŠ€æœ¯å®ç°æ–¹æ¡ˆ

### ä¸è®¿é—®æ§åˆ¶é›†æˆï¼ˆå…³é”®æ”¹åŠ¨ï¼‰

åœ¨ `lib/access.ts` ä¸­å¢åŠ ä¼šå‘˜æƒç›Šæ£€æŸ¥ï¼š
- å·²ç™»å½•ä¸”ä¼šå‘˜æœ‰æ•ˆï¼ˆtier = monthly/yearly ä¸”æœªè¿‡æœŸï¼Œæˆ– tier = lifetimeï¼‰â†’ ç›´æ¥ `hasAccess = true`ï¼Œå¿½ç•¥æœˆåº¦é¢åº¦é™åˆ¶ï¼›
- åŒ¿åç”¨æˆ·ç»§ç»­èµ° V1.2.2 çš„æœˆåº¦é¢åº¦é€»è¾‘ï¼ˆ`content_monthly_views` / `anon_monthly_views`ï¼‰ã€‚

ç¤ºä¾‹ä¼ªä»£ç ï¼š
```ts
const { data: { user } } = await supabase.auth.getUser();
if (user) {
  const { data: membership } = await supabase
    .from('user_memberships')
    .select('tier, expires_at')
    .eq('user_id', user.id)
    .maybeSingle();

  const active = !!membership && (
    membership.tier === 'lifetime' ||
    (membership.expires_at && new Date(membership.expires_at) > new Date())
  );

  if (active) {
    return { hasAccess: true, reason: 'membership' };
  }
}
// å¦åˆ™æŒ‰æœˆåº¦é¢åº¦é€»è¾‘å¤„ç†
```

### ç›®å½•ç»“æ„

```
jiangzao-main/
â”œâ”€â”€ app/
â”‚   â”œâ”€â”€ pricing/
â”‚   â”‚   â””â”€â”€ page.tsx                    # å®šä»·é¡µ
â”‚   â”œâ”€â”€ payment/
â”‚   â”‚   â””â”€â”€ result/
â”‚   â”‚       â””â”€â”€ page.tsx                # æ”¯ä»˜ç»“æœé¡µ
â”‚   â”œâ”€â”€ user/
â”‚   â”‚   â”œâ”€â”€ membership/
â”‚   â”‚   â”‚   â””â”€â”€ page.tsx                # ä¼šå‘˜ä¸­å¿ƒ
â”‚   â”‚   â””â”€â”€ reading-history/            # (å·²å­˜åœ¨)
â”‚   â”‚       â””â”€â”€ page.tsx
â”‚   â””â”€â”€ api/
â”‚       â”œâ”€â”€ payment/
â”‚       â”‚   â”œâ”€â”€ create-order/
â”‚       â”‚   â”‚   â””â”€â”€ route.ts            # åˆ›å»ºæ”¯ä»˜è®¢å•
â”‚       â”‚   â”œâ”€â”€ callback/
â”‚       â”‚   â”‚   â””â”€â”€ route.ts            # Z-Pay å›è°ƒæ¥å£
â”‚       â”‚   â””â”€â”€ check-status/
â”‚       â”‚       â””â”€â”€ [orderId]/
â”‚       â”‚           â””â”€â”€ route.ts        # æŸ¥è¯¢è®¢å•çŠ¶æ€
â”‚       â””â”€â”€ user/
â”‚           â””â”€â”€ membership/
â”‚               â””â”€â”€ route.ts            # è·å–ç”¨æˆ·ä¼šå‘˜ä¿¡æ¯
â”‚
â”œâ”€â”€ components/
â”‚   â”œâ”€â”€ pricing/
â”‚   â”‚   â”œâ”€â”€ PricingCard.tsx             # å¥—é¤å¡ç‰‡
â”‚   â”‚   â””â”€â”€ PaymentModal.tsx            # æ”¯ä»˜æ–¹å¼é€‰æ‹©å¼¹çª—
â”‚   â””â”€â”€ membership/
â”‚       â”œâ”€â”€ MembershipBadge.tsx         # ä¼šå‘˜æ ‡è¯†ç»„ä»¶
â”‚       â”œâ”€â”€ MembershipStatus.tsx        # ä¼šå‘˜çŠ¶æ€å¡ç‰‡
â”‚       â””â”€â”€ OrderHistory.tsx            # è®¢å•å†å²åˆ—è¡¨
â”‚
â”œâ”€â”€ lib/
â”‚   â”œâ”€â”€ zpay.ts                         # Z-Pay å·¥å…·åº“
â”‚   â”œâ”€â”€ membership.ts                   # ä¼šå‘˜ç®¡ç†å·¥å…·åº“ï¼ˆè¯»å†™ user_membershipsï¼‰
â”‚   â”œâ”€â”€ access.ts                       # è®¿é—®æ§åˆ¶ï¼šå·²å¯¹æ¥æœˆåº¦é…é¢ï¼›éœ€æ–°å¢ä¼šå‘˜æ£€æŸ¥
â”‚   â””â”€â”€ types.ts                        # (æ‰©å±•) æ–°å¢ç±»å‹
â”‚
â”œâ”€â”€ config/
â”‚   â””â”€â”€ membership.ts                   # ä¼šå‘˜å¥—é¤é…ç½®
â”‚
â””â”€â”€ supabase_migration_v1.3.1_orders.sql  # è®¢å•è¡¨è¿ç§»
```

---

## API æ¥å£è®¾è®¡

### 1. åˆ›å»ºæ”¯ä»˜è®¢å•

**ç«¯ç‚¹**: `POST /api/payment/create-order`

**è¯·æ±‚ä½“**:
```json
{
  "productType": "yearly",
  "paymentMethod": "alipay"
}
```

**å“åº” (æˆåŠŸ)**:
```json
{
  "success": true,
  "orderId": "JZ_20251104_1234567890",
  "paymentUrl": "https://zpayz.cn/submit.php?pid=xxx&...",
  "amount": 198,
  "productName": "å¹´ä¼šå‘˜"
}
```

**å“åº” (å¤±è´¥)**:
```json
{
  "success": false,
  "error": "ç”¨æˆ·æœªç™»å½•" | "å¥—é¤ç±»å‹æ— æ•ˆ" | "åˆ›å»ºè®¢å•å¤±è´¥"
}
```

**ä¸šåŠ¡é€»è¾‘**:
```typescript
1. éªŒè¯ç”¨æˆ·ç™»å½•çŠ¶æ€ (å¿…é¡»ç™»å½•)
2. éªŒè¯ productType (monthly/yearly/lifetime)
3. éªŒè¯ paymentMethod (alipay/wxpay)
4. ç”Ÿæˆå”¯ä¸€è®¢å•å·: JZ_YYYYMMDD_TIMESTAMP_RANDOM
5. è·å–å¥—é¤é…ç½® (ä»·æ ¼ã€æ—¶é•¿)
6. å†™å…¥ orders è¡¨ (status=pending)
7. è®¡ç®— Z-Pay ç­¾åï¼ˆè¿‡æ»¤ç©ºå€¼ã€æ’åºã€MD5 å°å†™ï¼‰
8. æ„é€ æ”¯ä»˜ URLï¼ˆå‰ç«¯ submit.php è·³è½¬æˆ–æœåŠ¡ç«¯ mapi.php è·å– pay_urlï¼‰
9. è¿”å›æ”¯ä»˜å‚æ•°
```

---

### 2. æ”¯ä»˜å›è°ƒæ¥å£

**ç«¯ç‚¹**: `POST /api/payment/callback`

**è¯·æ±‚ä½“** (Z-Pay å›è°ƒå‚æ•°ï¼Œ`application/x-www-form-urlencoded`):
```
pid=2025062920440492
&trade_no=20241104123456
&out_trade_no=JZ_20251104_1234567890
&type=alipay
&name=å¹´ä¼šå‘˜
&money=198.00
&trade_status=TRADE_SUCCESS
&sign=a1b2c3d4e5f6...
```

**å“åº”**:
```
success
```

**ä¸šåŠ¡é€»è¾‘**:
```typescript
1. éªŒè¯ç­¾å (MD5)
2. éªŒè¯ PID
3. éªŒè¯ trade_status (å¿…é¡»æ˜¯ TRADE_SUCCESS)
4. æŸ¥è¯¢è®¢å•è®°å½•
5. éªŒè¯è®¢å•é‡‘é¢
6. æ£€æŸ¥è®¢å•çŠ¶æ€ (é˜²æ­¢é‡å¤å›è°ƒ)
7. æ›´æ–°è®¢å•çŠ¶æ€: pending â†’ paid
8. ä¿å­˜å›è°ƒæ•°æ® (callback_data, callback_received_at)
9. æ¿€æ´»/å»¶é•¿ä¼šå‘˜:
   - æŸ¥è¯¢ user_memberships
   - å¦‚æœä¸å­˜åœ¨: INSERT (tier, expires_at)
   - å¦‚æœå·²å­˜åœ¨:
     - å¦‚æœå·²è¿‡æœŸ: expires_at = NOW() + duration
     - å¦‚æœæœªè¿‡æœŸ: expires_at = expires_at + duration
10. æ›´æ–°è®¢å•çŠ¶æ€: paid â†’ completed
11. è¿”å› "success"
```

**å®‰å…¨æœºåˆ¶**:
```typescript
// ç­¾åéªŒè¯ (é˜²æ­¢ä¼ªé€ å›è°ƒ)
// é‡‘é¢æ ¡éªŒ (é˜²æ­¢é‡‘é¢ç¯¡æ”¹)
// å¹‚ç­‰æ€§ (é˜²æ­¢é‡å¤å¤„ç†, ä»…å¤„ç† pending â†’ paid)
// åªå…è®¸ POST + å›ºå®š Content-Typeï¼ˆæ‹’ç» GET/JSONï¼‰
// è®°å½•æ‰€æœ‰å›è°ƒæ•°æ®åˆ° callback_dataï¼Œä¾¿äºè¿½è¸ªä¸å¯¹è´¦
```

---

### 3. æŸ¥è¯¢è®¢å•çŠ¶æ€

**ç«¯ç‚¹**: `GET /api/payment/check-status/[orderId]`

**å“åº”**:
```json
{
  "success": true,
  "order": {
    "orderId": "JZ_20251104_1234567890",
    "status": "paid",
    "productName": "å¹´ä¼šå‘˜",
    "amount": 198,
    "createdAt": "2025-11-04T15:30:00Z",
    "paidAt": "2025-11-04T15:32:00Z"
  }
}
```

**ä¸šåŠ¡é€»è¾‘**:
```typescript
1. éªŒè¯ç”¨æˆ·ç™»å½•çŠ¶æ€
2. æŸ¥è¯¢è®¢å•è®°å½•
3. éªŒè¯è®¢å•å½’å± (user_id === auth.uid())
4. è¿”å›è®¢å•çŠ¶æ€
```

---

### 4. è·å–ç”¨æˆ·ä¼šå‘˜ä¿¡æ¯

**ç«¯ç‚¹**: `GET /api/user/membership`

**å“åº”**:
```json
{
  "success": true,
  "membership": {
    "tier": "yearly",
    "expiresAt": "2026-11-04T15:30:00Z",
    "daysRemaining": 365,
    "isActive": true
  }
}
```

**ä¸šåŠ¡é€»è¾‘**:
```typescript
1. éªŒè¯ç”¨æˆ·ç™»å½•çŠ¶æ€
2. æŸ¥è¯¢ user_memberships è¡¨
3. è®¡ç®—å‰©ä½™å¤©æ•°
4. åˆ¤æ–­æ˜¯å¦æœ‰æ•ˆ (expires_at > NOW() æˆ– tier=lifetime)
5. è¿”å›ä¼šå‘˜ä¿¡æ¯
```

---

## å®‰å…¨æœºåˆ¶

### 1. Z-Pay ç­¾åéªŒè¯

**ç­¾åç®—æ³•** (åˆ›å»ºè®¢å•):
```typescript
function generateZPaySign(params: Record<string, any>, key: string): string {
  // 1. æ’é™¤ sign å’Œ sign_type
  const keys = Object.keys(params)
    .filter(k => k !== 'sign' && k !== 'sign_type' && params[k] !== undefined && params[k] !== null && `${params[k]}` !== '')
    .sort(); // 2. æŒ‰ key æ’åº

  // 3. æ‹¼æ¥æˆ key1=value1&key2=value2ï¼ˆå€¼éœ€ä¿æŒåŸå§‹ç¼–ç ï¼Œä¸è¿›è¡Œ URL ç¼–ç ï¼‰
  const paramStr = keys.map(k => `${k}=${params[k]}`).join('&');

  // 4. è¿½åŠ å•†æˆ·å¯†é’¥
  const signStr = paramStr + key;

  // 5. MD5 å°å†™
  return crypto.createHash('md5').update(signStr).digest('hex');
}
```

**ç­¾åéªŒè¯** (å›è°ƒ):
```typescript
function verifyZPaySign(params: Record<string, any>, key: string): boolean {
  const receivedSign = params.sign;
  const calculatedSign = generateZPaySign(params, key);
  return receivedSign === calculatedSign;
}
```

å…¶ä»–æ³¨æ„äº‹é¡¹ï¼š
- å›è°ƒä»…æ”¯æŒ `POST` + `application/x-www-form-urlencoded`ï¼›æ‹’ç» GET/JSONã€‚
- å›è°ƒå¤„ç†ä¸¥æ ¼å¹‚ç­‰ï¼šä»… `pending â†’ paid`ï¼Œå…¶ä½™çŠ¶æ€ç›´æ¥è¿”å› `success`ã€‚
- éªŒè¯ `pid`ã€`out_trade_no`ã€`trade_no`ã€`money` ä¸€è‡´æ€§ï¼›é‡‘é¢ä½¿ç”¨ `NUMERIC(10,2)` æ¯”è¾ƒã€‚
- å¯é€‰ï¼šæ ¡éªŒæ¥æº IP ç™½åå•ï¼ˆå¦‚ç½‘å…³æä¾›å›ºå®šå‡ºå£ï¼‰ã€‚

---

### 2. è®¢å•å¹‚ç­‰æ€§

**é—®é¢˜**: Z-Pay å¯èƒ½é‡å¤å‘é€å›è°ƒé€šçŸ¥

**è§£å†³æ–¹æ¡ˆ**:
```typescript
async function handlePaymentCallback(callbackData) {
  const { out_trade_no } = callbackData;

  // æŸ¥è¯¢è®¢å•
  const order = await getOrderByOrderId(out_trade_no);

  // æ£€æŸ¥çŠ¶æ€
  if (order.status !== 'pending') {
    console.log('è®¢å•å·²å¤„ç†,è·³è¿‡', order.status);
    return 'success'; // è¿”å›æˆåŠŸ,é¿å… Z-Pay é‡å¤é€šçŸ¥
  }

  // å¤„ç†æ”¯ä»˜é€»è¾‘...
  await updateOrderStatus(out_trade_no, 'paid');
  await activateMembership(order.user_id, order.product_type);

  return 'success';
}
```

---

### 3. é‡‘é¢äºŒæ¬¡æ ¡éªŒ

**é—®é¢˜**: å›è°ƒæ•°æ®å¯èƒ½è¢«ç¯¡æ”¹

**è§£å†³æ–¹æ¡ˆ**:
```typescript
// å›è°ƒä¸­éªŒè¯é‡‘é¢
if (parseFloat(callbackData.money) !== order.amount) {
  console.error('é‡‘é¢ä¸åŒ¹é…', {
    expected: order.amount,
    received: callbackData.money
  });
  throw new Error('AMOUNT_MISMATCH');
}
```

---

### 4. ä¼šå‘˜æ¿€æ´»åŸå­æ€§

**é—®é¢˜**: æ•°æ®åº“æ“ä½œå¤±è´¥å¯¼è‡´çŠ¶æ€ä¸ä¸€è‡´

**è§£å†³æ–¹æ¡ˆ**:
```typescript
async function activateMembership(userId, productType) {
  const supabase = createClient();

  // ä½¿ç”¨äº‹åŠ¡ (Supabase ä¸ç›´æ¥æ”¯æŒäº‹åŠ¡,ä½¿ç”¨ try-catch + å›æ»š)
  try {
    // 1. æ›´æ–°è®¢å•çŠ¶æ€
    await supabase
      .from('orders')
      .update({ status: 'paid' })
      .eq('order_id', orderId);

    // 2. æ¿€æ´»ä¼šå‘˜
    await supabase
      .from('user_memberships')
      .upsert({
        user_id: userId,
        tier: productType,
        expires_at: calculateExpiresAt(productType),
      });

    // 3. æ ‡è®°è®¢å•å®Œæˆ
    await supabase
      .from('orders')
      .update({ status: 'completed' })
      .eq('order_id', orderId);

  } catch (error) {
    // å›æ»šé€»è¾‘ (å¯é€‰)
    console.error('æ¿€æ´»ä¼šå‘˜å¤±è´¥', error);
    throw error;
  }
}
```

---

### 5. ç¯å¢ƒå˜é‡å®‰å…¨

**é…ç½®**:
```bash
# .env.local (æ°¸ä¸æäº¤åˆ° Git)
ZPAY_PID=2025062920440492
ZPAY_KEY=tNeFjVxC3b8IlgNJvqFA9oRNxy9ShaA1

# ç”Ÿäº§ç¯å¢ƒå›è°ƒåœ°å€
NEXT_PUBLIC_SITE_URL=https://jiangzao.com
```

**ä½¿ç”¨**:
```typescript
// ä»…åœ¨æœåŠ¡ç«¯ä½¿ç”¨
const ZPAY_KEY = process.env.ZPAY_KEY!;

// æ°¸ä¸æš´éœ²ç»™å®¢æˆ·ç«¯
```

---

## å®æ–½æ­¥éª¤

### Phase 1: æ•°æ®åº“åˆå§‹åŒ–

**ä»»åŠ¡æ¸…å•**:
- [x] æ‰§è¡Œ `supabase_migration_v1.3.0_membership.sql` (å·²å®Œæˆ)
- [ ] æ‰§è¡Œ `supabase_migration_v1.3.1_orders.sql` (åˆ›å»ºè®¢å•è¡¨)
- [ ] éªŒè¯è¡¨ç»“æ„å’Œ RLS ç­–ç•¥

**SQL æ–‡ä»¶**: å·²åœ¨ [æ•°æ®åº“è®¾è®¡](#æ•°æ®åº“è®¾è®¡) ç« èŠ‚æä¾›

---

### Phase 2: æ ¸å¿ƒå·¥å…·åº“

**ä»»åŠ¡æ¸…å•**:
- [ ] åˆ›å»º `lib/zpay.ts` (ç­¾åã€éªŒè¯)
- [ ] åˆ›å»º `lib/membership.ts` (ä¼šå‘˜ç®¡ç†)
- [ ] åˆ›å»º `config/membership.ts` (å¥—é¤é…ç½®)
- [ ] æ‰©å±• `lib/types.ts` (æ–°å¢ç±»å‹)

**é¢„è®¡å·¥æ—¶**: 2 å°æ—¶

---

### Phase 3: API è·¯ç”±å®ç°

**ä»»åŠ¡æ¸…å•**:
- [ ] `POST /api/payment/create-order` (åˆ›å»ºè®¢å•)
- [ ] `POST /api/payment/callback` (æ”¯ä»˜å›è°ƒ)
- [ ] `GET /api/payment/check-status/[orderId]` (æŸ¥è¯¢çŠ¶æ€)
- [ ] `GET /api/user/membership` (è·å–ä¼šå‘˜ä¿¡æ¯)

**é¢„è®¡å·¥æ—¶**: 4 å°æ—¶

---

### Phase 4: å‰ç«¯é¡µé¢å¼€å‘

**ä»»åŠ¡æ¸…å•**:
- [ ] `/pricing` å®šä»·é¡µ
- [ ] `/payment/result` æ”¯ä»˜ç»“æœé¡µ
- [ ] `/user/membership` ä¼šå‘˜ä¸­å¿ƒ
- [ ] `<MembershipBadge>` ä¼šå‘˜æ ‡è¯†ç»„ä»¶

**é¢„è®¡å·¥æ—¶**: 6 å°æ—¶

---

### Phase 5: æƒç›Šé›†æˆ

**ä»»åŠ¡æ¸…å•**:
- [ ] æ‰©å±• `lib/access.ts` åŠ å…¥ä¼šå‘˜æ£€æŸ¥
- [ ] ä¿®æ”¹ `PaywallOverlay.tsx` å¢åŠ ä¼šå‘˜å¼•å¯¼
- [ ] ä¿®æ”¹ `ViewLimitBanner.tsx` æ˜¾ç¤ºä¼šå‘˜çŠ¶æ€

**é¢„è®¡å·¥æ—¶**: 2 å°æ—¶

---

### Phase 6: æµ‹è¯•éªŒè¯

**ä»»åŠ¡æ¸…å•**:
- [ ] å•å…ƒæµ‹è¯• (ç­¾åç®—æ³•)
- [ ] é›†æˆæµ‹è¯• (å®Œæ•´æ”¯ä»˜æµç¨‹)
- [ ] è¾¹ç•Œæµ‹è¯• (é‡å¤å›è°ƒã€é‡‘é¢ç¯¡æ”¹)
- [ ] ç”¨æˆ·ä½“éªŒæµ‹è¯•

**é¢„è®¡å·¥æ—¶**: 3 å°æ—¶

---

### Phase 7: éƒ¨ç½²ä¸Šçº¿

**ä»»åŠ¡æ¸…å•**:
- [ ] é…ç½®ç”Ÿäº§ç¯å¢ƒ `ZPAY_PID` å’Œ `ZPAY_KEY`
- [ ] é…ç½®å›è°ƒåœ°å€: `https://jiangzao.com/api/payment/callback`
- [ ] åœ¨ Z-Pay åå°æµ‹è¯•æ”¯ä»˜
- [ ] ç›‘æ§è®¢å•å’Œä¼šå‘˜æ¿€æ´»

**é¢„è®¡å·¥æ—¶**: 1 å°æ—¶

---

### ç¯å¢ƒå˜é‡ä¸å¯†é’¥çº¦å®šï¼ˆæ–°å¢ï¼‰

åœ¨ `.env.local` é…ç½®ä»¥ä¸‹å˜é‡ï¼ˆä»…ä¾›æœåŠ¡ç«¯ä½¿ç”¨ï¼Œåˆ‡å‹¿æš´éœ²åˆ°å‰ç«¯ï¼‰ï¼š

```
# Z-Pay ç½‘å…³
ZPAY_PID=ä½ çš„å•†æˆ·PID
ZPAY_KEY=ä½ çš„å•†æˆ·å¯†é’¥
ZPAY_SUBMIT_URL=https://zpayz.cn/submit.php
ZPAY_MAPI_URL=https://zpayz.cn/mapi.php
ZPAY_NOTIFY_URL=https://yourdomain.com/api/payment/callback

# Supabase Service Roleï¼ˆä»…æœåŠ¡ç«¯ï¼‰
SUPABASE_SERVICE_ROLE_KEY=...  # ç”¨äº create-order/callback åœ¨æœåŠ¡ç«¯å®‰å…¨å†™åº“
```

è¯´æ˜ï¼š
- `/api/payment/create-order` ä¸ `/api/payment/callback` å»ºè®®ä½¿ç”¨ `SUPABASE_SERVICE_ROLE_KEY` åˆå§‹åŒ–æœåŠ¡ç«¯ Supabase å®¢æˆ·ç«¯ï¼Œä»¥åŒ¹é… RLS ä¸­çš„ `service_role` ç­–ç•¥ï¼›
- `/api/payment/check-status` ä¸ `/api/user/membership` ä½¿ç”¨ç”¨æˆ·æ€/anon keyï¼Œéµå¾ªç”¨æˆ·è§†è§’çš„æˆæƒï¼›

---

**æ€»é¢„è®¡å·¥æ—¶**: 18 å°æ—¶ (çº¦ 2-3 ä¸ªå·¥ä½œæ—¥)

---

## æµ‹è¯•è®¡åˆ’

### 1. å•å…ƒæµ‹è¯•

**ç­¾åç®—æ³•æµ‹è¯•**:
```typescript
describe('ZPay Sign', () => {
  it('should generate correct MD5 sign', () => {
    const params = {
      pid: '2025062920440492',
      out_trade_no: 'JZ_TEST_001',
      money: '19.9',
      type: 'alipay',
      notify_url: 'https://test.com/callback',
    };
    const key = 'test_key';
    const sign = generateZPaySign(params, key);
    expect(sign).toBe('expected_md5_hash');
  });
});
```

---

### 2. é›†æˆæµ‹è¯•

**å®Œæ•´æ”¯ä»˜æµç¨‹**:
```typescript
1. åˆ›å»ºè®¢å• (POST /api/payment/create-order)
   - éªŒè¯è¿”å› orderId å’Œ paymentUrl
   - éªŒè¯æ•°æ®åº“ orders è¡¨æœ‰è®°å½• (status=pending)

2. æ¨¡æ‹Ÿæ”¯ä»˜å›è°ƒ (POST /api/payment/callback)
   - å‘é€åˆæ³•ç­¾åçš„å›è°ƒæ•°æ®
   - éªŒè¯è¿”å› "success"
   - éªŒè¯è®¢å•çŠ¶æ€æ›´æ–°ä¸º paid
   - éªŒè¯ user_memberships è¡¨æœ‰è®°å½•

3. æŸ¥è¯¢è®¢å•çŠ¶æ€ (GET /api/payment/check-status/{orderId})
   - éªŒè¯çŠ¶æ€ä¸º paid
   - éªŒè¯ä¼šå‘˜ä¿¡æ¯æ­£ç¡®

4. è®¿é—®å†…å®¹ (GET /api/content/access)
   - éªŒè¯ä¼šå‘˜ç”¨æˆ· hasAccess=true
   - éªŒè¯å¯æ— é™é˜…è¯»
```

---

### 3. è¾¹ç•Œæµ‹è¯•

**é‡å¤å›è°ƒ**:
```typescript
1. ç¬¬ä¸€æ¬¡å›è°ƒ: è®¢å• pending â†’ paid
2. ç¬¬äºŒæ¬¡å›è°ƒ: è®¢å•çŠ¶æ€ä¸å˜,è¿”å› success
3. éªŒè¯ä¼šå‘˜ä¿¡æ¯æ²¡æœ‰é‡å¤æ¿€æ´»
```

**é‡‘é¢ç¯¡æ”¹**:
```typescript
1. åˆ›å»ºè®¢å•: amount=198
2. å›è°ƒæ—¶ä¿®æ”¹: money=1
3. éªŒè¯ç³»ç»Ÿæ‹’ç»å¤„ç†,è®¢å•çŠ¶æ€ä¿æŒ pending
```

**ç­¾åé”™è¯¯**:
```typescript
1. å‘é€é”™è¯¯ç­¾åçš„å›è°ƒ
2. éªŒè¯ç³»ç»Ÿæ‹’ç»å¤„ç†,è¿”å›é”™è¯¯
```

**è®¢å•è¶…æ—¶**:
```typescript
1. åˆ›å»ºè®¢å•å 24 å°æ—¶ä¸æ”¯ä»˜
2. éªŒè¯ç³»ç»Ÿæ ‡è®°ä¸º failed
```

---

### 4. ç”¨æˆ·ä½“éªŒæµ‹è¯•

**æµç¨‹éªŒè¯**:
```
1. æœªç™»å½•ç”¨æˆ·è®¿é—®å®šä»·é¡µ â†’ å¼•å¯¼ç™»å½•
2. ç™»å½•ç”¨æˆ·é€‰æ‹©å¥—é¤ â†’ è·³è½¬æ”¯ä»˜é¡µ
3. æ‰«ç æ”¯ä»˜ â†’ å‰ç«¯è½®è¯¢çŠ¶æ€
4. æ”¯ä»˜æˆåŠŸ â†’ è·³è½¬æˆåŠŸé¡µ,æ˜¾ç¤ºä¼šå‘˜ä¿¡æ¯
5. è®¿é—®å†…å®¹ â†’ æ— é™åˆ¶é˜…è¯»
6. æŸ¥çœ‹ä¼šå‘˜ä¸­å¿ƒ â†’ æ˜¾ç¤ºä¼šå‘˜çŠ¶æ€å’Œè®¢å•å†å²
```

---

## è¿ç»´ç›‘æ§

### 1. è®¢å•ç›‘æ§

**ç›‘æ§æŒ‡æ ‡**:
- æ¯æ—¥è®¢å•é‡
- è®¢å•æˆåŠŸç‡ (paid / total)
- å¹³å‡æ”¯ä»˜æ—¶é•¿
- è®¢å•å¤±è´¥åŸå› åˆ†å¸ƒ

**SQL æŸ¥è¯¢**:
```sql
-- ä»Šæ—¥è®¢å•ç»Ÿè®¡
SELECT
  COUNT(*) as total,
  COUNT(*) FILTER (WHERE status='paid') as paid,
  COUNT(*) FILTER (WHERE status='pending') as pending,
  COUNT(*) FILTER (WHERE status='failed') as failed,
  SUM(amount) as revenue
FROM orders
WHERE created_at >= CURRENT_DATE;

-- è®¢å•çŠ¶æ€åˆ†å¸ƒ
SELECT status, COUNT(*) as count
FROM orders
GROUP BY status;

-- å¥—é¤é”€é‡ç»Ÿè®¡
SELECT product_type, COUNT(*) as count, SUM(amount) as revenue
FROM orders
WHERE status IN ('paid', 'completed')
GROUP BY product_type;
```

---

### 2. ä¼šå‘˜ç›‘æ§

**ç›‘æ§æŒ‡æ ‡**:
- æ€»ä¼šå‘˜æ•°
- æ´»è·ƒä¼šå‘˜æ•° (æœªè¿‡æœŸ)
- ä¼šå‘˜ç±»å‹åˆ†å¸ƒ
- ä¼šå‘˜ç•™å­˜ç‡

**SQL æŸ¥è¯¢**:
```sql
-- ä¼šå‘˜ç»Ÿè®¡
SELECT
  tier,
  COUNT(*) as count,
  COUNT(*) FILTER (WHERE expires_at > NOW() OR tier='lifetime') as active
FROM user_memberships
GROUP BY tier;

-- å³å°†è¿‡æœŸä¼šå‘˜ (7å¤©å†…)
SELECT user_id, tier, expires_at
FROM user_memberships
WHERE expires_at BETWEEN NOW() AND NOW() + INTERVAL '7 days';
```

---

### 3. å¼‚å¸¸ç›‘æ§

**ç›‘æ§é¡¹**:
- å›è°ƒç­¾åéªŒè¯å¤±è´¥
- é‡‘é¢æ ¡éªŒå¤±è´¥
- è®¢å•çŠ¶æ€å¼‚å¸¸
- ä¼šå‘˜æ¿€æ´»å¤±è´¥

**æ—¥å¿—è®°å½•**:
```typescript
// è®°å½•æ‰€æœ‰å›è°ƒæ•°æ®
console.log('[ZPAY_CALLBACK]', {
  timestamp: new Date().toISOString(),
  orderId: callbackData.out_trade_no,
  tradeNo: callbackData.trade_no,
  amount: callbackData.money,
  status: callbackData.trade_status,
  signValid: isSignValid,
});

// è®°å½•å¼‚å¸¸
console.error('[ZPAY_ERROR]', {
  type: 'SIGN_INVALID',
  orderId: callbackData.out_trade_no,
  receivedSign: callbackData.sign,
  calculatedSign: expectedSign,
});
```

---

### 4. æŠ¥è­¦æœºåˆ¶

**æŠ¥è­¦è§„åˆ™**:
- è®¢å•æˆåŠŸç‡ < 90% â†’ å‘é€é‚®ä»¶
- 1 å°æ—¶å†…ç­¾åéªŒè¯å¤±è´¥ > 10 æ¬¡ â†’ å‘é€é‚®ä»¶
- ä¼šå‘˜æ¿€æ´»å¤±è´¥ â†’ ç«‹å³å‘é€é‚®ä»¶

---

## é™„å½•

### A. Z-Pay æ¥å£æ–‡æ¡£æ‘˜è¦

**å®˜æ–¹æ–‡æ¡£**: https://zpayz.cn/doc.html

**API ç«¯ç‚¹**:
- å‰ç«¯é‡å®šå‘åˆ›å»º: `https://zpayz.cn/submit.php`ï¼ˆç”¨æˆ·æµè§ˆå™¨è·³è½¬ï¼‰
- æœåŠ¡ç«¯åˆ›å»ºè®¢å•: `https://zpayz.cn/mapi.php`ï¼ˆServer-to-Serverï¼Œè¿”å›æ”¯ä»˜URLï¼‰
- æŸ¥è¯¢è®¢å•: `https://zpayz.cn/api.php?act=order`
- æŸ¥è¯¢ä½™é¢: `https://zpayz.cn/api.php?act=balance`

**å¿…éœ€å‚æ•°**ï¼ˆå¸¸è§ï¼‰:
- `pid`: å•†æˆ·ID
- `out_trade_no`: è®¢å•å·
- `money`: é‡‘é¢
- `type`: æ”¯ä»˜æ–¹å¼ (alipay/wxpay)
- `notify_url`: å›è°ƒåœ°å€
- `sign`: MD5 ç­¾å

**å›è°ƒå‚æ•°**:
- `trade_no`: Z-Pay äº¤æ˜“å·
- `out_trade_no`: å•†æˆ·è®¢å•å·
- `money`: é‡‘é¢
- `trade_status`: æ”¯ä»˜çŠ¶æ€ (TRADE_SUCCESS)
- `sign`: ç­¾å

---

### B. å¸¸è§é—®é¢˜

**Q1: ä¸ºä»€ä¹ˆå¿…é¡»ç™»å½•æ‰èƒ½è´­ä¹°?**
A: ä¼šå‘˜æƒç›Šéœ€è¦ç»‘å®šç”¨æˆ·è´¦å·,åŒ¿åç”¨æˆ·æ— æ³•äº«å—ä¼šå‘˜æœåŠ¡ã€‚

**Q2: æ”¯ä»˜æˆåŠŸä½†ä¼šå‘˜æœªæ¿€æ´»æ€ä¹ˆåŠ?**
A: ç³»ç»Ÿä¼šè‡ªåŠ¨é‡è¯•æ¿€æ´»,å¦‚æœæŒç»­å¤±è´¥è¯·è”ç³»å®¢æœ,æä¾›è®¢å•å·ã€‚

**Q3: ä¼šå‘˜åˆ°æœŸåä¼šè‡ªåŠ¨ç»­è´¹å—?**
A: ä¸ä¼šè‡ªåŠ¨ç»­è´¹,éœ€è¦æ‰‹åŠ¨è´­ä¹°ã€‚

**Q4: å¯ä»¥é€€æ¬¾å—?**
A: æ”¯æŒ 7 å¤©æ— ç†ç”±é€€æ¬¾,è”ç³»å®¢æœå¤„ç†ã€‚

**Q5: ç»ˆèº«ä¼šå‘˜åŒ…å«æœªæ¥æ–°åŠŸèƒ½å—?**
A: æ˜¯çš„,ç»ˆèº«ä¼šå‘˜å¯ä»¥ä¼˜å…ˆä½“éªŒæ‰€æœ‰æ–°åŠŸèƒ½ã€‚

---

### C. æŠ€æœ¯é€‰å‹è¯´æ˜

**ä¸ºä»€ä¹ˆé€‰æ‹© Z-Pay?**
- æ”¯æŒä¸ªäººå¼€å‘è€…æ¥å…¥
- å…è¥ä¸šæ‰§ç…§
- æ”¯æŒæ”¯ä»˜å®/å¾®ä¿¡æ”¯ä»˜
- API ç®€å•æ˜“ç”¨

**ä¸ºä»€ä¹ˆç”¨ PostgreSQL (Supabase)?**
- ä¸ç°æœ‰è®¤è¯ç³»ç»Ÿé›†æˆ
- æ”¯æŒ JSONB (å­˜å‚¨å›è°ƒæ•°æ®)
- å¼ºå¤§çš„ RLS å®‰å…¨ç­–ç•¥
- å…è´¹é¢åº¦å……è¶³

**ä¸ºä»€ä¹ˆç”¨ MD5 ç­¾å?**
- Z-Pay å®˜æ–¹æŒ‡å®šç®—æ³•
- ç®€å•é«˜æ•ˆ
- å®‰å…¨æ€§è¶³å¤Ÿ

---

### D. åç»­ä¼˜åŒ–æ–¹å‘

**V1.4 è®¡åˆ’**:
- [ ] æ”¯æŒä¼˜æƒ åˆ¸ç³»ç»Ÿ
- [ ] æ”¯æŒå¤šäººæ‹¼å›¢
- [ ] æ”¯æŒä¼šå‘˜æ¨èè¿”åˆ©
- [ ] æ”¯æŒè‡ªåŠ¨ç»­è´¹

**V2.0 è®¡åˆ’**:
- [ ] æ¥å…¥æ›´å¤šæ”¯ä»˜ç½‘å…³ (Stripe, PayPal)
- [ ] æ”¯æŒå›½é™…åŒ–æ”¯ä»˜
- [ ] æ”¯æŒä¼ä¸šè´¦å·
- [ ] æ”¯æŒå‘ç¥¨å¼€å…·

---

## æ–‡æ¡£ç»´æŠ¤

**åˆ›å»ºäºº**: Claude
**åˆ›å»ºæ—¶é—´**: 2025-11-04
**æœ€åæ›´æ–°**: 2025-11-04
**æ–‡æ¡£ç‰ˆæœ¬**: 1.0

**å˜æ›´è®°å½•**:
- 2025-11-04: åˆå§‹ç‰ˆæœ¬,å®Œæ•´æ”¯ä»˜ç³»ç»Ÿè®¾è®¡æ–¹æ¡ˆ

---

**ä¸‹ä¸€æ­¥**: å¼€å§‹å®æ–½ Phase 1 - æ•°æ®åº“åˆå§‹åŒ–

**æ³¨æ„äº‹é¡¹**:
1. æ‰§è¡Œ SQL å‰å¤‡ä»½æ•°æ®åº“
2. åœ¨å¼€å‘ç¯å¢ƒå……åˆ†æµ‹è¯•åå†ä¸Šç”Ÿäº§
3. å¯†é’¥æ°¸ä¸æäº¤åˆ° Git
4. æ‰€æœ‰é‡‘é¢è®¡ç®—ä½¿ç”¨ NUMERIC,é¿å…æµ®ç‚¹è¯¯å·®
5. å›è°ƒæ¥å£å¿…é¡»å¹‚ç­‰

**è”ç³»æ–¹å¼**:
å¦‚æœ‰ç–‘é—®,è¯·è”ç³»é¡¹ç›®è´Ÿè´£äººã€‚

---

**ğŸ‰ ç¥é¡¹ç›®æˆåŠŸ!**
