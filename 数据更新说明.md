
# 数据更新机制说明

## 🔄 当前更新频率配置

### 1. ISR (Incremental Static Regeneration) 配置
```
ISR_REVALIDATE=21600  # 6小时 = 21600秒
```

### 2. 工作原理

#### 开发模式 (`npm run dev`)
- **首次访问**: 从飞书获取最新数据
- **后续访问**: 可能使用缓存（开发模式缓存较短）
- **强制刷新**: Cmd/Ctrl + Shift + R

#### 生产模式 (`npm run build && npm start`)
- **首次访问**: 构建时获取数据，生成静态页面
- **6小时内访问**: 使用缓存的静态页面（速度极快）
- **6小时后首次访问**:
  - 用户看到缓存页面
  - 后台触发重新验证，获取最新数据
  - 下一个访问者看到更新后的内容

## 🎯 如何立即看到新发布的内容？

### 方法 1: 浏览器强制刷新（最简单）
```bash
Mac: Cmd + Shift + R
Windows: Ctrl + Shift + R
```

### 方法 2: 清除缓存并重启（开发模式）
```bash
rm -rf .next
npm run dev
```

### 方法 3: 使用手动刷新API（推荐）
```bash
# 刷新所有主要页面
curl -X POST http://localhost:3000/api/revalidate \
  -H "Content-Type: application/json" \
  -d '{}'

# 刷新指定页面
curl -X POST http://localhost:3000/api/revalidate \
  -H "Content-Type: application/json" \
  -d '{"path": "/"}'
```

### 方法 4: 等待自动刷新
- 在生产环境：等待最多6小时
- 在开发环境：刷新浏览器即可

## ⚠️ 当前问题：Node.js Fetch 网络错误

### 错误信息
```
Error: read ECONNRESET
errno: -54
code: 'ECONNRESET'
```

### 问题原因
Node.js内置fetch与飞书API的网络连接偶尔会重置，可能原因：
1. 网络不稳定
2. 飞书API限流
3. SSL/TLS握手问题
4. DNS解析问题

### 已实施的解决方案

#### 1. 重试机制（已添加）
```typescript
// lib/feishu.ts 中已实现3次重试，每次间隔1秒
for (let attempt = 1; attempt <= 3; attempt++) {
  try {
    const response = await fetch(url, {...});
    return response;
  } catch (error) {
    if (attempt < 3) {
      await new Promise(resolve => setTimeout(resolve, 1000));
    }
  }
}
```

#### 2. 手动刷新API（已创建）
- API路径: `/api/revalidate`
- 用于手动触发数据更新

### 其他解决方案（如果问题持续）

#### 方案A: 使用axios替代fetch
```bash
npm install axios
```

#### 方案B: 配置请求代理
```typescript
// 如果需要通过代理访问
const HttpsProxyAgent = require('https-proxy-agent');
const agent = new HttpsProxyAgent('http://proxy:port');
```

#### 方案C: 增加超时时间
```typescript
const controller = new AbortController();
const timeout = setTimeout(() => controller.abort(), 30000);

fetch(url, {
  signal: controller.signal,
  ...
})
```

## 📊 数据流程图

```
用户发布内容到飞书表格
    ↓
将"状态"改为"已发布"
    ↓
网站数据更新（以下任一方式）
    ↓
┌────────────────────────────────┐
│ 方式1: 等待ISR自动刷新（6小时） │
│ 方式2: 浏览器强制刷新            │
│ 方式3: 重启开发服务器            │
│ 方式4: 调用 /api/revalidate     │
└────────────────────────────────┘
    ↓
用户看到最新内容
```

## 🔧 测试数据是否已更新

### 1. 检查飞书表格
```bash
# 运行测试脚本
node scripts/test-feishu.js
```

### 2. 检查API响应
```bash
# 查看记录数量
curl -s 'http://localhost:3000/api/contents' | jq '.total'

# 查看第一条记录
curl -s 'http://localhost:3000/api/contents' | jq '.data[0]'
```

### 3. 直接访问网站
```
http://localhost:3000
```

## 🚀 推荐的工作流程

### 日常更新内容
1. 在飞书表格编辑/新增内容
2. 改状态为"已发布"
3. **开发环境**: 刷新浏览器即可
4. **生产环境**: 等待6小时或调用 `/api/revalidate`

### 紧急更新
1. 修改飞书数据
2. 立即调用刷新API:
```bash
curl -X POST https://yourdomain.com/api/revalidate
```
3. 30秒内即可看到更新

## 💡 优化建议

### 短期优化
- [x] 添加重试机制 ✅
- [x] 创建手动刷新API ✅
- [ ] 添加错误日志记录
- [ ] 优化缓存策略

### 长期优化
- [ ] 使用Redis缓存飞书数据
- [ ] 实现Webhook监听飞书变更
- [ ] 添加数据更新通知
- [ ] 图片CDN缓存

## 📞 如遇问题

如果数据始终无法更新，请检查：

1. ✅ 飞书应用权限是否正常
2. ✅ 环境变量配置是否正确
3. ✅ 网络连接是否稳定
4. ✅ 飞书表格"状态"字段是否为"已发布"
5. ✅ 必填字段是否都已填写

---

**更新时间**: 2025-10-31
**当前版本**: v1.0
**ISR配置**: 21600秒（6小时）
